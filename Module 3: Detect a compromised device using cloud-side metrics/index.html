


<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="Before deploying IoT Devices into production environment, it is crucial to have a strategy to identity potential security risks, and to respond quickly to the problem. This session shows you how to address security risks when managing IoT devices at scale. Using AWS IoT Device Defender, you audit device configuration and permission to ensure that desired security settings are in place. Next, you use cloud-side metrics provided by AWS IoT to detect unusual behaviors that could be coming from a compromised device. Finally, you implement solutions to take actions on these devices, using Device Defender Mitigation Actions, and AWS Lambda.">
      
      
      
        <meta name="author" content="aws-security-workshops@amazon.com">
      
      <link rel="shortcut icon" href="../docs/assets/images/aws-favicon.ico">
      <meta name="generator" content="mkdocs-1.1.2, mkdocs-material-5.5.3">
    
    
      
        <title>Module 3: Detect a compromised device using cloud-side metrics - Protect your IoT Fleet</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.947af8d5.min.css">
      
      
    
    
    
      
        <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700%7CRoboto+Mono&display=fallback">
        <style>body,input{font-family:"Roboto",-apple-system,BlinkMacSystemFont,Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono",SFMono-Regular,Consolas,Menlo,monospace}</style>
      
    
    
    
      <link rel="stylesheet" href="../stylesheets/custom.css">
    
    
      
    
    
  </head>
  
  
    <body dir="ltr">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#module-3-detect-a-compromised-device-using-cloud-side-metrics" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
      <!--
  Copyright (c) 2016-2018 Martin Donath <martin.donath@squidfunk.com>
  Permission is hereby granted, free of charge, to any person obtaining a copy
  of this software and associated documentation files (the "Software"), to
  deal in the Software without restriction, including without limitation the
  rights to use, copy, modify, merge, publish, distribute, sublicense, and/or
  sell copies of the Software, and to permit persons to whom the Software is
  furnished to do so, subject to the following conditions:
  The above copyright notice and this permission notice shall be included in
  all copies or substantial portions of the Software.
  THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
  IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
  FITNESS FOR A PARTICULAR PURPOSE AND NON-INFRINGEMENT. IN NO EVENT SHALL THE
  AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
  LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING
  FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS
  IN THE SOFTWARE.
-->

<!-- Application header -->
<header class="md-header" data-md-component="header">

    <!-- Top-level navigation -->
    <nav class="md-header-nav md-grid">
      <div class="md-flex">
  
        <!-- Link to home -->
        <div class="md-flex__cell md-flex__cell--shrink">
          <a href="https://aws.amazon.com/"
              title="Amazon Web Services"
              class="md-header-nav__button md-logo">
            
              <img src="../assets/images/aws_smile_logo.png" width="40" height="24" />
            
          </a>
        </div>
  
        <!-- Button to toggle drawer -->
        <div class="md-flex__cell md-flex__cell--shrink">
          <label class="md-icon md-icon--menu md-header-nav__button"
              for="__drawer"></label>
        </div>
  
        <!-- Header title -->
        <div class="md-flex__cell md-flex__cell--stretch">
          <div class="md-flex__ellipsis md-header-nav__title"
              data-md-component="title">
            
              
                <span class="md-header-nav__topic">
                  Protect your IoT Fleet
                </span>
                <span class="md-header-nav__topic">
                  Module 3: Detect a compromised device using cloud-side metrics
                </span>
              
            
          </div>
        </div>
        
        
        <!-- Button to open search dialogue -->
        <!--
        <div class="md-flex__cell md-flex__cell--shrink">
          
            
              <label class="md-icon md-icon--search md-header-nav__button"
                  for="__search"></label>
  
              
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" data-md-state="active">
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0116 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 019.5 16 6.5 6.5 0 013 9.5 6.5 6.5 0 019.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
      </label>
      <button type="reset" class="md-search__icon md-icon" aria-label="Clear" data-md-component="search-reset" tabindex="-1">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg>
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
            
          
        </div>

         -->
         
         <div class="md-flex__cell md-flex__cell--shrink">
            <div class="md-flex__ellipsis md-header-nav__lang">
                <div>
                    <button onclick="window.location.href = 'https://awssecworkshops.com/';" class="md-lang-dropbtn fa fa-home"></button>
                </div>
            </div>
        </div>
  
        <!-- Repository containing source -->
        
          <div class="md-flex__cell md-flex__cell--shrink">
            <div class="md-header-nav__source">
              
<a href="https://github.com/aws-samples/protect-your-iot-fleet/" title="Go to repository" class="md-source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M439.55 236.05L244 40.45a28.87 28.87 0 00-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 01-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 000 40.81l195.61 195.6a28.86 28.86 0 0040.8 0l194.69-194.69a28.86 28.86 0 000-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    aws-samples/protect-your-iot-fleet
  </div>
</a>
            </div>
          </div>
        
      </div>
    </nav>
  </header>
    
    <div class="md-container" data-md-component="container">
      
        
      
      
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <!--
  Copyright (c) 2016-2019 Martin Donath <martin.donath@squidfunk.com>
  Permission is hereby granted, free of charge, to any person obtaining a copy
  of this software and associated documentation files (the "Software"), to
  deal in the Software without restriction, including without limitation the
  rights to use, copy, modify, merge, publish, distribute, sublicense, and/or
  sell copies of the Software, and to permit persons to whom the Software is
  furnished to do so, subject to the following conditions:
  The above copyright notice and this permission notice shall be included in
  all copies or substantial portions of the Software.
  THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
  IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
  FITNESS FOR A PARTICULAR PURPOSE AND NON-INFRINGEMENT. IN NO EVENT SHALL THE
  AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
  LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING
  FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS
  IN THE SOFTWARE.
-->

<!-- Main navigation -->
<nav class="md-nav md-nav--primary" data-md-level="0">

  <!-- Site title -->
  <label class="md-nav__title md-nav__title--site" for="__drawer">
    <a href=".."
        title="Protect your IoT Fleet" class="md-nav__button md-logo">
      
        <img src="../assets/images/aws_smile_logo.png" width="48" height="48" />
      
    </a>
    
  </label>

  <!-- Repository containing source -->
  
    <div class="md-nav__source">
      
<a href="https://github.com/aws-samples/protect-your-iot-fleet/" title="Go to repository" class="md-source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M439.55 236.05L244 40.45a28.87 28.87 0 00-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 01-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 000 40.81l195.61 195.6a28.86 28.86 0 0040.8 0l194.69-194.69a28.86 28.86 0 000-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    aws-samples/protect-your-iot-fleet
  </div>
</a>
    </div>
  

  <!-- Render item list -->
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      


  <li class="md-nav__item">
    <a href=".." title="Overview" class="md-nav__link">
      Overview
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../Module%201%3A%20Environment%20build/" title="Module 1: Environment setup" class="md-nav__link">
      Module 1: Environment setup
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../Module%202%3A%20Audit%20your%20IoT%20Fleet/" title="Module 2: Audit your IoT Fleet" class="md-nav__link">
      Module 2: Audit your IoT Fleet
    </a>
  </li>

    
      
      
      

  


  <li class="md-nav__item md-nav__item--active">
    
    <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
    
      
    
    
      <label class="md-nav__link md-nav__link--active" for="__toc">
        Module 3: Detect a compromised device using cloud-side metrics
        <span class="md-nav__icon md-icon">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 9h14V7H3v2m0 4h14v-2H3v2m0 4h14v-2H3v2m16 0h2v-2h-2v2m0-10v2h2V7h-2m0 6h2v-2h-2v2z"/></svg>
        </span>
      </label>
    
    <a href="./" title="Module 3: Detect a compromised device using cloud-side metrics" class="md-nav__link md-nav__link--active">
      Module 3: Detect a compromised device using cloud-side metrics
    </a>
    
      
<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
      </span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#1-define-unusual-behaviors-of-your-devices" class="md-nav__link">
    1. Define unusual behaviors of your devices
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#2-respond-to-a-violation" class="md-nav__link">
    2. Respond to a violation
  </a>
  
    <nav class="md-nav" aria-label="2. Respond to a violation">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#21-create-iot-thing-group-that-denies-all-iot-actions" class="md-nav__link">
    2.1 Create IoT Thing Group that denies all IoT actions
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#22-use-lambda-function-to-move-device-into-thing-group" class="md-nav__link">
    2.2 Use Lambda function to move device into Thing Group
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#3-simulate-a-compromised-device" class="md-nav__link">
    3. Simulate a compromised device
  </a>
  
    <nav class="md-nav" aria-label="3. Simulate a compromised device">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#31-update-message-size" class="md-nav__link">
    3.1 Update message size
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
    
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../Module%204%3A%20Detect%20a%20compromised%20device%20using%20device-side%20metrics/" title="Module 4: Detect a compromised device using device-side metrics" class="md-nav__link">
      Module 4: Detect a compromised device using device-side metrics
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../Module%205%3A%20Send%20security%20alerts%20to%20your%20favourite%20messaging%20platform/" title="Module 5: Send security alerts to your favourite messaging platform" class="md-nav__link">
      Module 5: Send security alerts to your favourite messaging platform
    </a>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
      </span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#1-define-unusual-behaviors-of-your-devices" class="md-nav__link">
    1. Define unusual behaviors of your devices
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#2-respond-to-a-violation" class="md-nav__link">
    2. Respond to a violation
  </a>
  
    <nav class="md-nav" aria-label="2. Respond to a violation">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#21-create-iot-thing-group-that-denies-all-iot-actions" class="md-nav__link">
    2.1 Create IoT Thing Group that denies all IoT actions
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#22-use-lambda-function-to-move-device-into-thing-group" class="md-nav__link">
    2.2 Use Lambda function to move device into Thing Group
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#3-simulate-a-compromised-device" class="md-nav__link">
    3. Simulate a compromised device
  </a>
  
    <nav class="md-nav" aria-label="3. Simulate a compromised device">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#31-update-message-size" class="md-nav__link">
    3.1 Update message size
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                  <a href="https://github.com/aws-samples/protect-your-iot-fleet/edit/master/docs/Module 3: Detect a compromised device using cloud-side metrics/README.md" title="Edit this page" class="md-content__button md-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20.71 7.04c.39-.39.39-1.04 0-1.41l-2.34-2.34c-.37-.39-1.02-.39-1.41 0l-1.84 1.83 3.75 3.75M3 17.25V21h3.75L17.81 9.93l-3.75-3.75L3 17.25z"/></svg>
                  </a>
                
                
                  
                
                
                <h1 id="module-3-detect-a-compromised-device-using-cloud-side-metrics">Module 3: Detect a compromised device using cloud-side metrics</h1>
<p>In Module 2, you learned how to set up automation to audit devices configuration and implement mitigation actions. With additional security requirements from your IT organization, you need to have a solution in place to detect unusual behaviors of IoT devices, which can indicate that devices are compromised and participate in bad activities (for example, participate in a DDoS attack). You also need to find a solution to quickly response to this changes in device's behaviors. Becuase these IoT devices are used to send temperature telemetry, you identify one behavior indicates that a device is compromised: sending very large message compared to the regular message, which only has temperature telemetry.</p>
<p>This module will walk you through neccessary steps to use metrics collected by AWS IoT (cloud-side metrics) to detect a compromised devices.</p>
<ol>
<li><a href="#1-define-unusual-behaviors-of-your-devices">Define unusual behaviors of your devices</a></li>
<li><a href="#2-respond-to-a-violation">Respond to a violation</a></li>
<li><a href="#3-simulate-a-compromised-device">Simulate a compromised device</a></li>
</ol>
<h2 id="1-define-unusual-behaviors-of-your-devices">1. Define unusual behaviors of your devices</h2>
<p>Your task is to implement a solution to detect unusual behaviors of IoT devices. How do you know if a device acts differently than its regular behavior? You need to have metrics related to the device's activities, and you need to define when the value of each metric is considered outside of regularity.</p>
<p>AWS IoT Device Defender Detect monitor cloud-side metrics to detect abnormal behaviors (such as the number of authorization failures, or the number or size of messages a device sends or receives through AWS IoT). However, you need to tell Device Defender when these metrics aren't normal.</p>
<p>To do that, you need to create a <strong>Security Profile</strong>. A security profile defines abnomal behaviors for a group of devices (a thing group) or for all devices in your account, and specifies what actions to take when an anomaly is detected. </p>
<p>In this case, you will create a Security Profile to allow Device Defender to monitor the message size of all three devices. The Software Development Team didn't share with you average message size of each message. But Device Defender can use <a href="https://docs.aws.amazon.com/iot/latest/developerguide/device-defender-detect.html#detect-behaviors">statisticalThreshold</a> to detect if incoming messages are larger then the average message size. </p>
<ul>
<li>
<p>Sign in to your AWS account. From AWS console home, go to IoT console</p>
</li>
<li>
<p>On the left side of IoT Console, Click <strong>Defend, Detect, Security Profiles, Create your first security profile</strong>. Name this security profile as <strong>DetectLargeMessageSize</strong>. </p>
</li>
<li>
<p>Under <strong>Behaviors</strong>, create a behavior named <strong>LargeMessageSize</strong>. We ask Device Defender to observe message size and alert us it transmits messages whose cumulative size is more than 1000bytes in a minute. </p>
</li>
<li>
<p>Click on drop down list under <strong>Metric</strong>, and choose metric <strong>Message Size</strong>. Choose <strong>Check Type</strong> as <strong>Statistical Threshold</strong>. </p>
</li>
<li>
<p>For <strong>Operator</strong>, choose <strong>Greater than</strong>. Specify <strong>p50</strong> for <strong>Statistical Threshold</strong>. That means, the criteria to trigger alert is when the incoming message size is larger than the 50% of all measurements.</p>
</li>
<li>
<p>Choose <strong>5 minutes</strong> for <strong>Duration</strong>. For a Statistical Threshold check type, this is the time window during which metrics are collected from all devices to determine the statistical ranking of the data from an individual device.</p>
</li>
<li>
<p>For <strong>Datapoints to Alarm</strong>, specify <strong>1</strong>. If a device is in violation of this behavior for 1 datapoints, an alarm occurs.</p>
</li>
<li>
<p>For <strong>Datapoints to Clear</strong>, specify <strong>1</strong>. If an alarm has occured, and the offending device is no longer in violation of the behavior for 1 consecutive datapoints, the alarm is cleared.</p>
</li>
</ul>
<p><img src="../images/behaviors.png"/></p>
<ul>
<li>
<p>You need to keep the mesage size metrics of each message for investigation. Under <strong>Addionional Metrics to retain</strong>, click on <strong>Select</strong> on the right corner to see drop down list of metrics that we can retain. Select <strong>Message size</strong>. You also need to keep track of how many messages are sent and received between AWS IoT and each device in a given period. To keep this metric, select <strong>Message received</strong>. Then click <strong>Next</strong></p>
</li>
<li>
<p>Select a SNS topic for alerts when a device violates a behavior in this profile. An SNS topic was created for you in advance. This step is similar to <a href="/Module%202:%20Audit%20your%20IoT%20Fleet/README.md#11-check-audit-settings">Module 2, session 1.1, Option 1, step 9 and 10</a>. Select SNS topic <strong>BadIoTDevices-[CloudFormation stackname]</strong>. For IAM Role, select IAM role with this naming convention <strong>[CloudFormation-stack-name]-SNSTopicRole-[random-value]</strong>. If you worked on Module 2 of this workshop, you should already subcribed your email to this topic <strong>BadIoTDevices-[CloudFormation stackname]</strong>. If you haven't subscribed your email, don't forget to do so.</p>
</li>
</ul>
<p><img src="../images/snsdetect.png"/></p>
<ul>
<li>You need to attach this security profile to a target. A target can be a thing, or a thing group, or every devices. For simplicity, we will attach this security profile with <strong>All things</strong> for now.</li>
</ul>
<p><img src="../images/target.png"/></p>
<p>Click <strong>Next</strong> to view summary of this Security Profile. When you confirm everything is correct, then click <strong>Save</strong></p>
<h2 id="2-respond-to-a-violation">2. Respond to a violation</h2>
<p>After you figure out how to detect unusual device's behaviors, next step is to respond to this violation. </p>
<p>This session walk you through how to create a simple automation that will move violated device to an IoT Thing Group specifically for investigation. You attach an IAM policy to this Thing Group so that the devices in this Thing Group do not have any permision to perform any IoT actions.</p>
<h3 id="21-create-iot-thing-group-that-denies-all-iot-actions">2.1 Create IoT Thing Group that denies all IoT actions</h3>
<ul>
<li>Sign in to your AWS account, click on IoT Device Defender.</li>
<li>From IoT management console, click <strong>Manage</strong>, <strong>Thing groups</strong>, <strong>Create</strong>, <strong>Create Thing Group</strong> . Name your thing group  as <strong>IsolatedDevices</strong> and click <strong>Create thing group</strong></li>
</ul>
<p><img src="../images/CreateThingGroup.png"/></p>
<ul>
<li>
<p>Next, create a policy that deny all <strong>IoT actions</strong> </p>
</li>
<li>
<p>Go back to main AWS IoT console, click on <strong>Secure, Policies, Create</strong>. Name your new policy. </p>
</li>
<li>
<p>Under <strong>Add statements*<em>, type **iot:</em></strong> for <strong>Action</strong>, and <strong>'*'</strong> for <strong>Resource ARN</strong>. Check <strong>Deny</strong> box, and click <strong>Create</strong>. </p>
</li>
</ul>
<p><strong>Note that this policy only denies all IoT actions. If your devices have additional permission to work with others AWS services (for example, permission to Put an item in DynamoDB table), this policy won't deny those permission.</strong></p>
<p><img src="../images/DenyAll.png"/></p>
<ul>
<li>Associate this policy with Thing Group that we create earlier. Go to <strong>Manage, Thing groups</strong>. Click on the Thing Group <strong>IsolatedDevices, Security, Edit</strong>. Select the policy that you create earlier, and click <strong>Save</strong></li>
</ul>
<p><img src="../images/AttachDenyAll.png"/></p>
<p>Any device in Thing Group <strong>IsolatedDevices</strong> will not have permission to send data to AWS IoT.</p>
<p>Next, you use a Lambda function to move offending devices to this Thing Group</p>
<h3 id="22-use-lambda-function-to-move-device-into-thing-group">2.2 Use Lambda function to move device into Thing Group</h3>
<p>In this step, you use a Lambda function to move offending device to <strong>IsolatedDevices</strong> thing group for forensics. When Device Defender finds a violation and sends alerts to SNS topic that you created earlier, SNS will trigger this Lambda function.</p>
<blockquote>
<p>Note: in this Lab, we expect to have 1-2 violations, which means the Lambda function will be triggered no more than 2 times. </p>
</blockquote>
<ul>
<li>
<p>A Lambda function <strong>IsolateDevice</strong> was already created in advance for you.</p>
</li>
<li>
<p>To understand what this Lambda function does, go to Lambda console, click <strong>Function</strong>. Click <strong>IsolateDevice</strong></p>
</li>
<li>
<p>Under <strong>Function Code</strong>, you will see Python code below. When alert from Device Defender Detect is sent to SNS topic <strong>BadIoTDevices-[CloudFormation stackname]</strong>, SNS will trigger this Lambda function. This function will parse the SNS message to retrieve offending device's name, and add this device to Thing Group <strong>IsolatedDevices</strong></p>
</li>
</ul>
<blockquote>
<p>Note: you need to  provide Thing Group name to this function, and subscribe Lambda function to SNS topic by following steps below.</p>
</blockquote>
<div class="codehilite"><pre><span></span><code><span class="kn">import</span> <span class="nn">boto3</span>
<span class="kn">import</span> <span class="nn">json</span>

<span class="n">iot</span> <span class="o">=</span> <span class="n">boto3</span><span class="o">.</span><span class="n">client</span><span class="p">(</span><span class="s1">&#39;iot&#39;</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">lambda_handler</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="n">context</span><span class="p">):</span>
    <span class="n">message</span> <span class="o">=</span> <span class="n">event</span><span class="p">[</span><span class="s1">&#39;Records&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;Sns&#39;</span><span class="p">][</span><span class="s1">&#39;Message&#39;</span><span class="p">]</span>
    <span class="n">d</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
    <span class="n">thing</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;thingName&#39;</span><span class="p">]</span>

    <span class="n">addThing</span> <span class="o">=</span> <span class="n">iot</span><span class="o">.</span><span class="n">add_thing_to_thing_group</span><span class="p">(</span>
        <span class="n">thingGroupName</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;ThingGroupName&#39;</span><span class="p">],</span>
    <span class="n">thingName</span><span class="o">=</span><span class="n">thing</span>
    <span class="p">)</span>
</code></pre></div>


<ul>
<li>
<p>You need to provide Thing Group name for this Lambda function. To do so, you create an Environment Variables.</p>
</li>
<li>
<p>Scroll down to <strong>Environment Variables</strong>, click <strong>Manage environment variables</strong></p>
</li>
<li>
<p>Click <strong>Add environment variable</strong>. Type <strong>ThingGroupName</strong> as Key (need to be exactly as ThingGroupName), and <strong>IsolatedDevices</strong> as Value. Click Save.</p>
</li>
<li>
<p>Now this function is ready to be invoked. The next thing to do is to configure SNS topic to trigger this function.</p>
</li>
<li>
<p>On the function console, expand <strong>Designer</strong> </p>
</li>
</ul>
<p><img src="../images/designerlambda.png"/></p>
<ul>
<li>Click <strong>Add trigger</strong>. Select <strong>SNS</strong>. Select topic <strong>BadIoTDevices-[CloudFormation stackname]</strong>. Check <strong>Enable trigger</strong>. And click <strong>Add</strong> to make this SNS topic as a trigger of your function.</li>
</ul>
<p><img src="../images/snstriggerlambda.png"/></p>
<p><strong>IsolateDevice</strong> is now receiving events from trigger SNS topic <strong>BadIoTDevices-[CloudFormation stackname]</strong>. That means, it will move offending device to Thing Group <strong>IsolatedDevice</strong> when Device Defender alerts a violation. Next step, you are going to test if this automation works as expected.</p>
<h2 id="3-simulate-a-compromised-device">3. Simulate a compromised device</h2>
<p>In this step, you update SensorDevice02's code to similate a situation that its message is very large compared with regular message size. Because this behavior can indate that the device is compromised, you want to stop this device from taking any IoT actions, and move it to quarantive Thing Group to investigate further.</p>
<h3 id="31-update-message-size">3.1 Update message size</h3>
<ul>
<li>To update the message size SensorDevice02 is sending to AWS IoT, go to Lambda management console, click on function <strong>SensorDevice02</strong>. Scroll down and comment out the code that generate random temperature telemetry data so line 57 looks like the following:</li>
</ul>
<div class="codehilite"><pre><span></span><code><span class="err">    #telemetrydata = round(random.uniform(15.1,29.9),2)</span>
</code></pre></div>


<ul>
<li>Instead, create a large random string has 3000 characters. To do so, uncomment the line of code below (line 60)</li>
</ul>
<div class="codehilite"><pre><span></span><code><span class="err">    telemetrydata = &#39;&#39;.join(random.choices(string.ascii_uppercase + string.digits, k = 3000)) </span>
</code></pre></div>


<ul>
<li>Click <strong>Save</strong> on the topc right corner. After saving this code change, your new code should look like this:</li>
</ul>
<p><img src="../images/codechange.png"/></p>
<p>After this change, each message from <strong>SensorDevice02</strong> device will have 3000 characters - which is very abnormal compared to regular message size (only have a 3-4 characters)</p>
<p>Now we wait for a few minutes until you receive email from SNS. After that you can go to <strong>Manage, Thing Groups, IsolatedDevices, Things</strong> to see that <strong>Thing02</strong> should be added to this group. Now let's check if this device has stopped sending telemetry data by going to <strong>Test, Subscribe to a topic</strong>, enter the topic <strong>temperature-device-02</strong>. </p>
<p>If your automation in step 2 works. You shouldn't see any message there because we have associated <strong>DenyAll</strong> policy to Thing Group <strong>IsolatedDevices</strong></p>
<p>Congratulations! By completing this module, you have learned how to detect unusual behaviors of IoT devices, and stop offending devices to take any IoT actions. </p>
<p>Next, move to <a href="../Module%204:%20Detect%20a%20compromised%20device%20using%20device-side%20metrics">Module 4: Detect a compromised device using device-side metrics</a> to use device-side metrics to detect compromised devices.</p>
                
              
              
                


              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid" aria-label="Footer">
        
          <a href="../Module%202%3A%20Audit%20your%20IoT%20Fleet/" title="Module 2: Audit your IoT Fleet" class="md-footer-nav__link md-footer-nav__link--prev" rel="prev">
            <div class="md-footer-nav__button md-icon">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
            </div>
            <div class="md-footer-nav__title">
              <div class="md-ellipsis">
                <span class="md-footer-nav__direction">
                  Previous
                </span>
                Module 2: Audit your IoT Fleet
              </div>
            </div>
          </a>
        
        
          <a href="../Module%204%3A%20Detect%20a%20compromised%20device%20using%20device-side%20metrics/" title="Module 4: Detect a compromised device using device-side metrics" class="md-footer-nav__link md-footer-nav__link--next" rel="next">
            <div class="md-footer-nav__title">
              <div class="md-ellipsis">
                <span class="md-footer-nav__direction">
                  Next
                </span>
                Module 4: Detect a compromised device using device-side metrics
              </div>
            </div>
            <div class="md-footer-nav__button md-icon">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4z"/></svg>
            </div>
          </a>
        
      </nav>
    </div>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
          <div class="md-footer-copyright__highlight">
            &copy; 2020, Amazon Web Services, Inc. or its affiliates. All rights reserved.
          </div>
        
        Made with
        <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
          Material for MkDocs
        </a>
      </div>
      
  <div class="md-footer-social">
    
      
      
        
        
      
      <a href="https://awssecworkshops.com" target="_blank" rel="noopener" title="awssecworkshops.com" class="md-footer-social__link">
        
      </a>
    
      
      
        
        
      
      <a href="https://aws.amazon.com/security/" target="_blank" rel="noopener" title="aws.amazon.com" class="md-footer-social__link">
        
      </a>
    
      
      
        
        
      
      <a href="https://twitter.com/awssecurityinfo?lang=en" target="_blank" rel="noopener" title="twitter.com" class="md-footer-social__link">
        
      </a>
    
      
      
        
        
      
      <a href="https://aws.amazon.com/blogs/security/" target="_blank" rel="noopener" title="aws.amazon.com" class="md-footer-social__link">
        
      </a>
    
  </div>

    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../assets/javascripts/vendor.c3dc8c49.min.js"></script>
      <script src="../assets/javascripts/bundle.f9edbbd5.min.js"></script><script id="__lang" type="application/json">{"clipboard.copy": "Copy to clipboard", "clipboard.copied": "Copied to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.result.placeholder": "Type to start searching", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents"}</script>
      
      <script>
        app = initialize({
          base: "..",
          features: [],
          search: Object.assign({
            worker: "../assets/javascripts/worker/search.8e2cddea.min.js"
          }, typeof search !== "undefined" && search)
        })
      </script>
      
    
  </body>
</html>