


<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="Before deploying IoT Devices into production environment, it is crucial to have a strategy to identity potential security risks, and to respond quickly to the problem. This session shows you how to address security risks when managing IoT devices at scale. Using AWS IoT Device Defender, you audit device configuration and permission to ensure that desired security settings are in place. Next, you use cloud-side metrics provided by AWS IoT to detect unusual behaviors that could be coming from a compromised device. Finally, you implement solutions to take actions on these devices, using Device Defender Mitigation Actions, and AWS Lambda.">
      
      
      
        <meta name="author" content="aws-security-workshops@amazon.com">
      
      <link rel="shortcut icon" href="../docs/assets/images/aws-favicon.ico">
      <meta name="generator" content="mkdocs-1.1.2, mkdocs-material-5.5.3">
    
    
      
        <title>Module 4: Detect a compromised device using device-side metrics - Protect your IoT Fleet</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.947af8d5.min.css">
      
      
    
    
    
      
        <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700%7CRoboto+Mono&display=fallback">
        <style>body,input{font-family:"Roboto",-apple-system,BlinkMacSystemFont,Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono",SFMono-Regular,Consolas,Menlo,monospace}</style>
      
    
    
    
      <link rel="stylesheet" href="../stylesheets/custom.css">
    
    
      
    
    
  </head>
  
  
    <body dir="ltr">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#module-4-detect-a-compromised-device-using-device-side-metrics" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
      <!--
  Copyright (c) 2016-2018 Martin Donath <martin.donath@squidfunk.com>
  Permission is hereby granted, free of charge, to any person obtaining a copy
  of this software and associated documentation files (the "Software"), to
  deal in the Software without restriction, including without limitation the
  rights to use, copy, modify, merge, publish, distribute, sublicense, and/or
  sell copies of the Software, and to permit persons to whom the Software is
  furnished to do so, subject to the following conditions:
  The above copyright notice and this permission notice shall be included in
  all copies or substantial portions of the Software.
  THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
  IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
  FITNESS FOR A PARTICULAR PURPOSE AND NON-INFRINGEMENT. IN NO EVENT SHALL THE
  AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
  LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING
  FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS
  IN THE SOFTWARE.
-->

<!-- Application header -->
<header class="md-header" data-md-component="header">

    <!-- Top-level navigation -->
    <nav class="md-header-nav md-grid">
      <div class="md-flex">
  
        <!-- Link to home -->
        <div class="md-flex__cell md-flex__cell--shrink">
          <a href="https://aws.amazon.com/"
              title="Amazon Web Services"
              class="md-header-nav__button md-logo">
            
              <img src="../assets/images/aws_smile_logo.png" width="40" height="24" />
            
          </a>
        </div>
  
        <!-- Button to toggle drawer -->
        <div class="md-flex__cell md-flex__cell--shrink">
          <label class="md-icon md-icon--menu md-header-nav__button"
              for="__drawer"></label>
        </div>
  
        <!-- Header title -->
        <div class="md-flex__cell md-flex__cell--stretch">
          <div class="md-flex__ellipsis md-header-nav__title"
              data-md-component="title">
            
              
                <span class="md-header-nav__topic">
                  Protect your IoT Fleet
                </span>
                <span class="md-header-nav__topic">
                  Module 4: Detect a compromised device using device-side metrics
                </span>
              
            
          </div>
        </div>
        
        
        <!-- Button to open search dialogue -->
        <!--
        <div class="md-flex__cell md-flex__cell--shrink">
          
            
              <label class="md-icon md-icon--search md-header-nav__button"
                  for="__search"></label>
  
              
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" data-md-state="active">
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0116 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 019.5 16 6.5 6.5 0 013 9.5 6.5 6.5 0 019.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
      </label>
      <button type="reset" class="md-search__icon md-icon" aria-label="Clear" data-md-component="search-reset" tabindex="-1">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg>
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
            
          
        </div>

         -->
         
         <div class="md-flex__cell md-flex__cell--shrink">
            <div class="md-flex__ellipsis md-header-nav__lang">
                <div>
                    <button onclick="window.location.href = 'https://awssecworkshops.com/';" class="md-lang-dropbtn fa fa-home"></button>
                </div>
            </div>
        </div>
  
        <!-- Repository containing source -->
        
          <div class="md-flex__cell md-flex__cell--shrink">
            <div class="md-header-nav__source">
              
<a href="https://github.com/aws-samples/protect-your-iot-fleet/" title="Go to repository" class="md-source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M439.55 236.05L244 40.45a28.87 28.87 0 00-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 01-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 000 40.81l195.61 195.6a28.86 28.86 0 0040.8 0l194.69-194.69a28.86 28.86 0 000-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    aws-samples/protect-your-iot-fleet
  </div>
</a>
            </div>
          </div>
        
      </div>
    </nav>
  </header>
    
    <div class="md-container" data-md-component="container">
      
        
      
      
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <!--
  Copyright (c) 2016-2019 Martin Donath <martin.donath@squidfunk.com>
  Permission is hereby granted, free of charge, to any person obtaining a copy
  of this software and associated documentation files (the "Software"), to
  deal in the Software without restriction, including without limitation the
  rights to use, copy, modify, merge, publish, distribute, sublicense, and/or
  sell copies of the Software, and to permit persons to whom the Software is
  furnished to do so, subject to the following conditions:
  The above copyright notice and this permission notice shall be included in
  all copies or substantial portions of the Software.
  THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
  IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
  FITNESS FOR A PARTICULAR PURPOSE AND NON-INFRINGEMENT. IN NO EVENT SHALL THE
  AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
  LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING
  FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS
  IN THE SOFTWARE.
-->

<!-- Main navigation -->
<nav class="md-nav md-nav--primary" data-md-level="0">

  <!-- Site title -->
  <label class="md-nav__title md-nav__title--site" for="__drawer">
    <a href=".."
        title="Protect your IoT Fleet" class="md-nav__button md-logo">
      
        <img src="../assets/images/aws_smile_logo.png" width="48" height="48" />
      
    </a>
    
  </label>

  <!-- Repository containing source -->
  
    <div class="md-nav__source">
      
<a href="https://github.com/aws-samples/protect-your-iot-fleet/" title="Go to repository" class="md-source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M439.55 236.05L244 40.45a28.87 28.87 0 00-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 01-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 000 40.81l195.61 195.6a28.86 28.86 0 0040.8 0l194.69-194.69a28.86 28.86 0 000-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    aws-samples/protect-your-iot-fleet
  </div>
</a>
    </div>
  

  <!-- Render item list -->
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      


  <li class="md-nav__item">
    <a href=".." title="Overview" class="md-nav__link">
      Overview
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../Module%201%3A%20Environment%20build/" title="Module 1: Environment setup" class="md-nav__link">
      Module 1: Environment setup
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../Module%202%3A%20Audit%20your%20IoT%20Fleet/" title="Module 2: Audit your IoT Fleet" class="md-nav__link">
      Module 2: Audit your IoT Fleet
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../Module%203%3A%20Detect%20a%20compromised%20device%20using%20cloud-side%20metrics/" title="Module 3: Detect a compromised device using cloud-side metrics" class="md-nav__link">
      Module 3: Detect a compromised device using cloud-side metrics
    </a>
  </li>

    
      
      
      

  


  <li class="md-nav__item md-nav__item--active">
    
    <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
    
      
    
    
      <label class="md-nav__link md-nav__link--active" for="__toc">
        Module 4: Detect a compromised device using device-side metrics
        <span class="md-nav__icon md-icon">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 9h14V7H3v2m0 4h14v-2H3v2m0 4h14v-2H3v2m16 0h2v-2h-2v2m0-10v2h2V7h-2m0 6h2v-2h-2v2z"/></svg>
        </span>
      </label>
    
    <a href="./" title="Module 4: Detect a compromised device using device-side metrics" class="md-nav__link md-nav__link--active">
      Module 4: Detect a compromised device using device-side metrics
    </a>
    
      
<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
      </span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#1-configure-sensordevice03-to-send-telemetry-data-to-aws-iot" class="md-nav__link">
    1. Configure SensorDevice03 to send telemetry data to AWS IoT
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#2-install-aws-device-defender-agent-to-collect-metrics-on-the-device" class="md-nav__link">
    2. Install AWS Device Defender Agent to collect metrics on the device
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#3-define-unusual-behaviors" class="md-nav__link">
    3. Define unusual behaviors
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#4-respond-to-violations" class="md-nav__link">
    4. Respond to violations
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#5-simulate-a-compromised-device" class="md-nav__link">
    5. Simulate a compromised device
  </a>
  
    <nav class="md-nav" aria-label="5. Simulate a compromised device">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#51-update-message-size" class="md-nav__link">
    5.1 Update message size
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
    
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../Module%205%3A%20Send%20security%20alerts%20to%20your%20favourite%20messaging%20platform/" title="Module 5: Send security alerts to your favourite messaging platform" class="md-nav__link">
      Module 5: Send security alerts to your favourite messaging platform
    </a>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
      </span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#1-configure-sensordevice03-to-send-telemetry-data-to-aws-iot" class="md-nav__link">
    1. Configure SensorDevice03 to send telemetry data to AWS IoT
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#2-install-aws-device-defender-agent-to-collect-metrics-on-the-device" class="md-nav__link">
    2. Install AWS Device Defender Agent to collect metrics on the device
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#3-define-unusual-behaviors" class="md-nav__link">
    3. Define unusual behaviors
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#4-respond-to-violations" class="md-nav__link">
    4. Respond to violations
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#5-simulate-a-compromised-device" class="md-nav__link">
    5. Simulate a compromised device
  </a>
  
    <nav class="md-nav" aria-label="5. Simulate a compromised device">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#51-update-message-size" class="md-nav__link">
    5.1 Update message size
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                  <a href="https://github.com/aws-samples/protect-your-iot-fleet/edit/master/docs/Module 4: Detect a compromised device using device-side metrics/README.md" title="Edit this page" class="md-content__button md-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20.71 7.04c.39-.39.39-1.04 0-1.41l-2.34-2.34c-.37-.39-1.02-.39-1.41 0l-1.84 1.83 3.75 3.75M3 17.25V21h3.75L17.81 9.93l-3.75-3.75L3 17.25z"/></svg>
                  </a>
                
                
                  
                
                
                <h1 id="module-4-detect-a-compromised-device-using-device-side-metrics">Module 4: Detect a compromised device using device-side metrics</h1>
<p>In previous module, you used cloud-side metrics capture by AWS IoT to monitor and detect if a device has an abnormal behavior. You also built a solution to automatically isolate the device for quarantine. In this module you will learn how to monitor and stop suspicious device from any actions, by using metrics capture from the device itself. </p>
<h2 id="1-configure-sensordevice03-to-send-telemetry-data-to-aws-iot">1. Configure SensorDevice03 to send telemetry data to AWS IoT</h2>
<p>Device SensorDevice03 hasn't sent any temperature data to AWS IoT. In this step, you will need to start a bootstrap script on the device. This script will generate random temperature data and send it to AWS IoT endpoint.</p>
<ul>
<li>
<p>Open your Cloud9 environment. From Cloud9 environment terminal, go to directory below to run bootstrap script:</p>
<div class="codehilite"><pre><span></span><code><span class="err">cd /home/ec2-user/environment</span>
<span class="err">git clone https://github.com/hongpham/Workshop-Protect-your-IoT-fleet.git</span>
<span class="err">cd Workshop-Protect-your-IoT-fleet/</span>
<span class="err">cd &#39;Module 4: Detect a compromised device using device-side metrics&#39;</span>
</code></pre></div>


</li>
<li>
<p>Run script bootstrap.sh to install dependencies and make this device to send data to AWS IoT (make sure you are at directory 'Module 4: Detect a compromised device using device-side metrics'). In this workshop, the default topic name is <strong>temperature-device-03</strong>, default device name is <strong>SensorDevice03</strong>. See screenshot in step 4 for an example. </p>
<div class="codehilite"><pre><span></span><code><span class="p">.</span><span class="o">/</span><span class="n">bootstrap</span><span class="p">.</span><span class="n">sh</span> <span class="o">-</span><span class="n">t</span> <span class="p">[</span><span class="n">topic</span> <span class="n">name</span><span class="p">]</span> <span class="o">-</span><span class="n">n</span> <span class="p">[</span><span class="n">device</span> <span class="n">name</span><span class="p">]</span>
</code></pre></div>


</li>
<li>
<p>The script will write AWS IoT Endpoint to a temporary file under /tmp/endpoint. You will need this endpoint later. </p>
</li>
<li>
<p>This bootstrap script will start a python program in the background to send data to AWS IoT topic <strong>temperature-device-03</strong>. To validate if this device is sendind telemetry data, you can check if the script is running by the command below.</p>
<div class="codehilite"><pre><span></span><code><span class="err"> ps aux |grep python   #this command search for the current running processes that has &#39;python&#39; in it&#39;s name</span>
</code></pre></div>


</li>
</ul>
<p>If you see a process like <strong>'python startdevice.py -t [topic name] -d [device name]</strong>, this device is sending telemetry data to AWS IoT.</p>
<p><img src="../images/bootstrapscript.png"/></p>
<h2 id="2-install-aws-device-defender-agent-to-collect-metrics-on-the-device">2. Install AWS Device Defender Agent to collect metrics on the device</h2>
<p>In this step, you will install <a href="https://github.com/aws-samples/aws-iot-device-defender-agent-sdk-python">AWS Device Defender Agent (Python version)</a> on this device <strong>SensorDevice03</strong></p>
<ul>
<li>
<p>Run these commands to install Agent</p>
<div class="codehilite"><pre><span></span><code><span class="err"> cd /home/ec2-user/environment/workshop</span>
<span class="err"> sudo pip install -r requirements.txt </span>
<span class="err"> sudo pip install AWSIoTDeviceDefenderAgentSDK</span>
</code></pre></div>


</li>
<li>
<p>Open a text editor, retrieve neccesary parameters below and save it in your text editor. You will need these parameters to start Device Defender Agent</p>
<p>a. AWS IoT Endpoint: when you run bootstrap.sh script to bootstrap the device, the script retrieve AWS IoT endpoint and save it under /tmp/endpoint. In the terminal, you can run the command  below to retrieve the endpoint:</p>
<div class="codehilite"><pre><span></span><code><span class="err">  cat /tmp/endpoint</span>
</code></pre></div>


</li>
</ul>
<p><strong><details><summary>Click here if you can't find AWS IoT endpoint in /tmp/endpoint</summary><br></strong></p>
<div class="codehilite"><pre><span></span><code><span class="w"> </span><span class="mf">1.</span><span class="w"> </span><span class="k">If</span><span class="w"> </span><span class="n">you</span><span class="w"> </span><span class="n">don</span><span class="err">&#39;</span><span class="n">t</span><span class="w"> </span><span class="n">have</span><span class="w"> </span><span class="n">AWS</span><span class="w"> </span><span class="n">IoT</span><span class="w"> </span><span class="n">Endpoint</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="k">file</span><span class="w"> </span><span class="o">/</span><span class="n">tmp</span><span class="o">/</span><span class="n">endpoint</span><span class="p">,</span><span class="w"> </span><span class="n">you</span><span class="w"> </span><span class="n">can</span><span class="w"> </span><span class="n">retrieve</span><span class="w"> </span><span class="n">it</span><span class="w"> </span><span class="n">manually</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">AWS</span><span class="w"> </span><span class="n">IoT</span><span class="w"> </span><span class="n">Console</span><span class="p">.</span><span class="w"></span>

<span class="w"> </span><span class="mf">2.</span><span class="w"> </span><span class="k">Go</span><span class="w"> </span><span class="k">to</span><span class="w"> </span><span class="o">**</span><span class="n">AWS</span><span class="w"> </span><span class="n">IoT</span><span class="w"> </span><span class="n">Core</span><span class="w"> </span><span class="n">console</span><span class="o">**</span><span class="p">.</span><span class="w"> </span><span class="n">Make</span><span class="w"> </span><span class="n">sure</span><span class="w"> </span><span class="n">that</span><span class="w"> </span><span class="n">you</span><span class="w"> </span><span class="k">are</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">correct</span><span class="w"> </span><span class="n">region</span><span class="p">.</span><span class="w"> </span><span class="n">Click</span><span class="w"> </span><span class="o">**</span><span class="n">Manage</span><span class="o">**</span><span class="w"> </span><span class="k">to</span><span class="w"> </span><span class="k">view</span><span class="w"> </span><span class="n">list</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="n">IoT</span><span class="w"> </span><span class="n">things</span><span class="p">.</span><span class="w"> </span><span class="n">Click</span><span class="w"> </span><span class="k">on</span><span class="w"> </span><span class="ow">any</span><span class="w"> </span><span class="n">thing</span><span class="p">,</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">example</span><span class="w"> </span><span class="o">**</span><span class="n">Thing01</span><span class="o">**</span><span class="p">.</span><span class="w"> </span><span class="n">Click</span><span class="w"> </span><span class="o">**</span><span class="n">Interact</span><span class="o">**</span><span class="p">.</span><span class="w"> </span><span class="n">Copy</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">Rest</span><span class="w"> </span><span class="n">API</span><span class="w"> </span><span class="n">endpoint</span><span class="w"> </span><span class="k">under</span><span class="w"> </span><span class="o">**</span><span class="n">HTTPS</span><span class="o">**</span><span class="w"></span>

<span class="w">    </span><span class="o">&lt;</span><span class="n">img</span><span class="w"> </span><span class="n">src</span><span class="o">=</span><span class="ss">&quot;../images/endpoint.png&quot;</span><span class="o">/&gt;</span><span class="w"></span>
</code></pre></div>


</details>

<div class="codehilite"><pre><span></span><code><span class="n">b</span><span class="p">.</span> <span class="n">Device</span> <span class="n">name</span><span class="p">:</span> <span class="k">in</span> <span class="n">this</span> <span class="n">workshop</span><span class="p">,</span> <span class="k">default</span> <span class="n">device</span> <span class="n">name</span> <span class="k">is</span>  <span class="o">**</span><span class="n">SensorDevice03</span><span class="o">**</span>

<span class="k">c</span><span class="p">.</span> <span class="n">Thing</span> <span class="n">name</span><span class="p">:</span> <span class="k">in</span> <span class="n">this</span> <span class="n">workshop</span><span class="p">,</span> <span class="k">default</span> <span class="n">thing</span> <span class="n">name</span> <span class="k">is</span> <span class="o">**</span><span class="n">Thing03</span><span class="o">**</span>
</code></pre></div>


<ul>
<li>
<p>Extend Agent Connection timeout: the minimum interval to send device metrics to Device Defender is 5 minutes (300 s). In this workshop, to make sure the established connection between device and AWS IoT will not be closed when the Agent is collecting data, you will need to increase ConnectionTimeout</p>
<p>a. Make sure you are in directory AWSIoTDeviceDefenderAgentSDK. Change timeout configuration by editing agent.py </p>
<div class="codehilite"><pre><span></span><code><span class="err">cd /home/ec2-user/environment/workshop/AWSIoTDeviceDefenderAgentSDK</span>
<span class="err">vi agent.py</span>
</code></pre></div>


<p>b. Change the values of <strong>configureConnectDisconnectTimeout</strong> and <strong>configureMQTTOperationTimeout</strong> to <strong>1800</strong> seconds (30 minutes) </p>
<p><img src="../images/contimeout.png"/></p>
<p>c. Save and close agent.py by pressing <strong>Esc</strong> on the keyboard, then type <strong>:wq</strong></p>
</li>
<li>
<p>Start Device Defender Agent by running this command</p>
<div class="codehilite"><pre><span></span><code><span class="n">python</span> <span class="n">agent</span><span class="p">.</span><span class="n">py</span> <span class="o">--</span><span class="n">endpoint</span> <span class="p">[</span><span class="n">your</span> <span class="n">AWS</span> <span class="n">IoT</span> <span class="n">endpoint</span> <span class="n">retrieved</span> <span class="n">from</span> <span class="n">step</span> <span class="mf">2.</span><span class="n">a</span> <span class="n">above</span><span class="p">]</span>  \
<span class="o">--</span><span class="n">rootCA</span> <span class="o">/</span><span class="n">tmp</span><span class="o">/</span><span class="n">rootca</span><span class="p">.</span><span class="n">pem</span>  <span class="o">--</span><span class="n">cert</span> <span class="o">/</span><span class="n">tmp</span><span class="o">/</span><span class="n">cert</span><span class="p">.</span><span class="n">pem</span> <span class="o">--</span><span class="n">key</span> <span class="o">/</span><span class="n">tmp</span><span class="o">/</span><span class="n">private</span><span class="p">.</span><span class="n">key</span> \
<span class="o">--</span><span class="n">client_id</span> <span class="p">[</span><span class="n">Device</span> <span class="n">name</span><span class="p">]</span> <span class="o">--</span><span class="n">thing_name</span> <span class="p">[</span><span class="n">Thing</span> <span class="n">name</span><span class="p">]</span> <span class="o">--</span><span class="n">format</span> <span class="n">json</span> <span class="o">-</span><span class="n">i</span> <span class="mi">300</span> <span class="o">&gt;</span> <span class="n">agent</span><span class="p">.</span><span class="k">out</span> <span class="mi">2</span><span class="o">&gt;&amp;</span><span class="mi">1</span>
</code></pre></div>


</li>
</ul>
<p><img src="../images/startagent.png"/></p>
<p>If you notice, you will see that X.509 certificate and it's private key is requried to start Device Defender Agent. These are credentials the Agent will use to send to AWS IoT. These credentials are already download for you under /tmp directory.</p>
<p>The Agent will collect metrics and sends to AWS IoT as json format every 300 seconds (or 5 minutes - which is minimum reporting interval)</p>
<ul>
<li>After a few minutes, you should see a message confirm that Agent is sending metrics data to AWS IoT</li>
</ul>
<p><img src="../images/metricssent.png"/></p>
<p>Let the Agent run for a 10-15 minutes. Move to next step to configure device behaviors on Device Defender.</p>
<h2 id="3-define-unusual-behaviors">3. Define unusual behaviors</h2>
<p>Your task is to implement a solution to detect unusual behaviors on the IoT device itself. Like in Module 3, you need to define when the value of each metric is considered outside of regularity.</p>
<p>You need to create a new <strong>Security Profile</strong>. In this case, you will create a Security Profile to allow Device Defender to monitor the bytes sent from the device. Device Defender can use <a href="https://docs.aws.amazon.com/iot/latest/developerguide/device-defender-detect.html#detect-behaviors">statisticalThreshold</a> to detect if outgoing messages from your device are larger then the average number of bytes sent. </p>
<ul>
<li>
<p>Go to the IoT console.</p>
</li>
<li>
<p>On the left side of IoT Console, Click <strong>Defend, Detect, Security Profiles</strong>. Click the <strong>Create</strong> button on the upper right hand corner. </p>
</li>
<li>
<p>Name this security profile as <strong>DetectSendingMoreThanAverageBytes</strong>.</p>
</li>
<li>
<p>Under <strong>Behaviors</strong>, create a behavior named <strong>MoreBytesSent</strong>. We ask Device Defender to observe the number of bytes and alert us it transmits sends a message that's more than 200 bytes. </p>
</li>
<li>
<p>Click on drop down list under <strong>Metric</strong>, and choose metric <strong>Bytes out</strong>. Choose <strong>Check Type</strong> as <strong>Absolute value</strong> to check the exact number of bytes sent.</p>
</li>
<li>
<p>For <strong>Operator</strong>, choose <strong>Greater than</strong>. Specify <strong>200</strong> for <strong>Vale</strong>. That means if the number of bytes in a message sent from the device is more than 200 bytes, it will trigger an alert.</p>
</li>
<li>
<p>Choose <strong>5 minutes</strong> for <strong>Duration</strong> and leave the default <strong>1</strong> for both <strong>Datapoints to alarm</strong> and <strong>Datapoints to clear</strong>.</p>
</li>
<li>
<p>Expand the <strong>Additional Metrics to retain</strong> and check the box next to <strong>Bytes out</strong>. Click <strong>Next</strong>.</p>
</li>
<li>
<p>On the next page, send messages to the same SNS topic from Module 3 - <strong>BadIoTDevices-<CFNStackName></strong> and select the role that starts with <strong><CFNStackName>-SNSTopicRole-</strong> to grant permission for Device Defender to publish on the SNS topic. Click <strong>Next</strong>.</p>
</li>
<li>
<p>Check the box next to <strong>All things</strong> too attach the security profile to all IoT things. Click <strong>Next</strong>.</p>
</li>
<li>
<p>Review that the configuration is as detailed above and click <strong>Save</strong>, then <strong>Continue</strong>.</p>
</li>
</ul>
<h2 id="4-respond-to-violations">4. Respond to violations</h2>
<p>Once your message violates the security profile, it will trigger a message to be sent to the SNS topic.
The SNS topic will trigger the same lambda function as Module 3. As before, when this lambda function is triggered, it will move the IoT Thing that represents your Cloud9 instance, to the isolated thing group.</p>
<h2 id="5-simulate-a-compromised-device">5. Simulate a compromised device</h2>
<p>In this section, we will be simulating a device that has been compromised and sending more data than it is supposed to send. </p>
<h3 id="51-update-message-size">5.1 Update message size</h3>
<ul>
<li>
<p>To update the number of bytes the Cloud9 instance will send to AWS IoT, go to the Cloud9 service page, under <strong>Your environments</strong>, click  <strong>Open IDE</strong> in the environment named <strong>SensorDevice03</strong>. </p>
</li>
<li>
<p>From Cloud9 environment terminal, go to directory below to run bootstrap script:</p>
<div class="codehilite"><pre><span></span><code><span class="err">cd /home/ec2-user/environment</span>
<span class="err">git clone https://github.com/hongpham/Workshop-Protect-your-IoT-fleet.git</span>
<span class="err">cd Workshop-Protect-your-IoT-fleet/</span>
<span class="err">cd &#39;Module 4: Detect a compromised device using device-side metrics&#39;</span>
</code></pre></div>


</li>
</ul>
<p><strong>After repo is published, use CFN to download repo to Cloud9 during provisioning. Need to update git repo name after it's published. Also need to put a screen shot of these command.</strong></p>
<ul>
<li>Open the <code>startdevice.py</code> file:</li>
</ul>
<div class="codehilite"><pre><span></span><code><span class="err">vim startdevice.py</span>
</code></pre></div>


<ul>
<li>Go to line 86 and comment out the current telementrydata that generate random temperature telemetry data so line 86 looks like the following:</li>
</ul>
<div class="codehilite"><pre><span></span><code><span class="err">    #telemetrydata = round(random.uniform(15.1,29.9),2)</span>
</code></pre></div>


<ul>
<li>Instead, create a large random string has 3000 characters. To do so, uncomment the line of code below (line 89)</li>
</ul>
<div class="codehilite"><pre><span></span><code><span class="err">    telemetrydata = &#39;&#39;.join(random.choices(string.ascii_uppercase + string.digits, k = 3000)) </span>
</code></pre></div>


<ul>
<li>Save this code change and re-run the bootstrap script:</li>
</ul>
<div class="codehilite"><pre><span></span><code><span class="p">.</span><span class="o">/</span><span class="n">bootstrap</span><span class="p">.</span><span class="n">sh</span> <span class="o">-</span><span class="n">t</span> <span class="p">[</span><span class="n">topic</span> <span class="n">name</span><span class="p">]</span> <span class="o">-</span><span class="n">n</span> <span class="p">[</span><span class="n">device</span> <span class="n">name</span><span class="p">]</span>
</code></pre></div>


<ul>
<li>The device is now sending more bytes out than it should be. After 5 minutes, the device should show up in the <strong>IsolatedDevices</strong>.</li>
</ul>
<p>Congrationlations! You have successfully used Device Defender Agent to monitor device behaviors from the device itself. If you have time to work on extra-credit challenges, move on to <a href="../Module%205%3A%20Send%20security%20alerts%20to%20your%20favourite%20messaging%20platform/">Module 5: Send security alerts to your favourite messaging platform</a></p>
                
              
              
                


              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid" aria-label="Footer">
        
          <a href="../Module%203%3A%20Detect%20a%20compromised%20device%20using%20cloud-side%20metrics/" title="Module 3: Detect a compromised device using cloud-side metrics" class="md-footer-nav__link md-footer-nav__link--prev" rel="prev">
            <div class="md-footer-nav__button md-icon">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
            </div>
            <div class="md-footer-nav__title">
              <div class="md-ellipsis">
                <span class="md-footer-nav__direction">
                  Previous
                </span>
                Module 3: Detect a compromised device using cloud-side metrics
              </div>
            </div>
          </a>
        
        
          <a href="../Module%205%3A%20Send%20security%20alerts%20to%20your%20favourite%20messaging%20platform/" title="Module 5: Send security alerts to your favourite messaging platform" class="md-footer-nav__link md-footer-nav__link--next" rel="next">
            <div class="md-footer-nav__title">
              <div class="md-ellipsis">
                <span class="md-footer-nav__direction">
                  Next
                </span>
                Module 5: Send security alerts to your favourite messaging platform
              </div>
            </div>
            <div class="md-footer-nav__button md-icon">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4z"/></svg>
            </div>
          </a>
        
      </nav>
    </div>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
          <div class="md-footer-copyright__highlight">
            &copy; 2020, Amazon Web Services, Inc. or its affiliates. All rights reserved.
          </div>
        
        Made with
        <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
          Material for MkDocs
        </a>
      </div>
      
  <div class="md-footer-social">
    
      
      
        
        
      
      <a href="https://awssecworkshops.com" target="_blank" rel="noopener" title="awssecworkshops.com" class="md-footer-social__link">
        
      </a>
    
      
      
        
        
      
      <a href="https://aws.amazon.com/security/" target="_blank" rel="noopener" title="aws.amazon.com" class="md-footer-social__link">
        
      </a>
    
      
      
        
        
      
      <a href="https://twitter.com/awssecurityinfo?lang=en" target="_blank" rel="noopener" title="twitter.com" class="md-footer-social__link">
        
      </a>
    
      
      
        
        
      
      <a href="https://aws.amazon.com/blogs/security/" target="_blank" rel="noopener" title="aws.amazon.com" class="md-footer-social__link">
        
      </a>
    
  </div>

    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../assets/javascripts/vendor.c3dc8c49.min.js"></script>
      <script src="../assets/javascripts/bundle.f9edbbd5.min.js"></script><script id="__lang" type="application/json">{"clipboard.copy": "Copy to clipboard", "clipboard.copied": "Copied to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.result.placeholder": "Type to start searching", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents"}</script>
      
      <script>
        app = initialize({
          base: "..",
          features: [],
          search: Object.assign({
            worker: "../assets/javascripts/worker/search.8e2cddea.min.js"
          }, typeof search !== "undefined" && search)
        })
      </script>
      
    
  </body>
</html>