


<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="Before deploying IoT Devices into production environment, it is crucial to have a strategy to identity potential security risks, and to respond quickly to the problem. This session shows you how to address security risks when managing IoT devices at scale. Using AWS IoT Device Defender, you audit device configuration and permission to ensure that desired security settings are in place. Next, you use cloud-side metrics provided by AWS IoT to detect unusual behaviors that could be coming from a compromised device. Finally, you implement solutions to take actions on these devices, using Device Defender Mitigation Actions, and AWS Lambda.">
      
      
      
        <meta name="author" content="aws-security-workshops@amazon.com">
      
      <link rel="shortcut icon" href="../docs/assets/images/aws-favicon.ico">
      <meta name="generator" content="mkdocs-1.1.2, mkdocs-material-5.5.3">
    
    
      
        <title>Module 2: Audit your IoT Fleet - Protect your IoT Fleet</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.947af8d5.min.css">
      
      
    
    
    
      
        <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700%7CRoboto+Mono&display=fallback">
        <style>body,input{font-family:"Roboto",-apple-system,BlinkMacSystemFont,Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono",SFMono-Regular,Consolas,Menlo,monospace}</style>
      
    
    
    
      <link rel="stylesheet" href="../stylesheets/custom.css">
    
    
      
    
    
  </head>
  
  
    <body dir="ltr">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#module-2-audit-your-iot-fleet" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
      <!--
  Copyright (c) 2016-2018 Martin Donath <martin.donath@squidfunk.com>
  Permission is hereby granted, free of charge, to any person obtaining a copy
  of this software and associated documentation files (the "Software"), to
  deal in the Software without restriction, including without limitation the
  rights to use, copy, modify, merge, publish, distribute, sublicense, and/or
  sell copies of the Software, and to permit persons to whom the Software is
  furnished to do so, subject to the following conditions:
  The above copyright notice and this permission notice shall be included in
  all copies or substantial portions of the Software.
  THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
  IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
  FITNESS FOR A PARTICULAR PURPOSE AND NON-INFRINGEMENT. IN NO EVENT SHALL THE
  AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
  LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING
  FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS
  IN THE SOFTWARE.
-->

<!-- Application header -->
<header class="md-header" data-md-component="header">

    <!-- Top-level navigation -->
    <nav class="md-header-nav md-grid">
      <div class="md-flex">
  
        <!-- Link to home -->
        <div class="md-flex__cell md-flex__cell--shrink">
          <a href="https://aws.amazon.com/"
              title="Amazon Web Services"
              class="md-header-nav__button md-logo">
            
              <img src="../assets/images/aws_smile_logo.png" width="40" height="24" />
            
          </a>
        </div>
  
        <!-- Button to toggle drawer -->
        <div class="md-flex__cell md-flex__cell--shrink">
          <label class="md-icon md-icon--menu md-header-nav__button"
              for="__drawer"></label>
        </div>
  
        <!-- Header title -->
        <div class="md-flex__cell md-flex__cell--stretch">
          <div class="md-flex__ellipsis md-header-nav__title"
              data-md-component="title">
            
              
                <span class="md-header-nav__topic">
                  Protect your IoT Fleet
                </span>
                <span class="md-header-nav__topic">
                  Module 2: Audit your IoT Fleet
                </span>
              
            
          </div>
        </div>
        
        
        <!-- Button to open search dialogue -->
        <!--
        <div class="md-flex__cell md-flex__cell--shrink">
          
            
              <label class="md-icon md-icon--search md-header-nav__button"
                  for="__search"></label>
  
              
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" data-md-state="active">
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0116 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 019.5 16 6.5 6.5 0 013 9.5 6.5 6.5 0 019.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
      </label>
      <button type="reset" class="md-search__icon md-icon" aria-label="Clear" data-md-component="search-reset" tabindex="-1">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg>
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
            
          
        </div>

         -->
         
         <div class="md-flex__cell md-flex__cell--shrink">
            <div class="md-flex__ellipsis md-header-nav__lang">
                <div>
                    <button onclick="window.location.href = 'https://awssecworkshops.com/';" class="md-lang-dropbtn fa fa-home"></button>
                </div>
            </div>
        </div>
  
        <!-- Repository containing source -->
        
          <div class="md-flex__cell md-flex__cell--shrink">
            <div class="md-header-nav__source">
              
<a href="https://github.com/aws-samples/protect-your-iot-fleet/" title="Go to repository" class="md-source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M439.55 236.05L244 40.45a28.87 28.87 0 00-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 01-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 000 40.81l195.61 195.6a28.86 28.86 0 0040.8 0l194.69-194.69a28.86 28.86 0 000-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    aws-samples/protect-your-iot-fleet
  </div>
</a>
            </div>
          </div>
        
      </div>
    </nav>
  </header>
    
    <div class="md-container" data-md-component="container">
      
        
      
      
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <!--
  Copyright (c) 2016-2019 Martin Donath <martin.donath@squidfunk.com>
  Permission is hereby granted, free of charge, to any person obtaining a copy
  of this software and associated documentation files (the "Software"), to
  deal in the Software without restriction, including without limitation the
  rights to use, copy, modify, merge, publish, distribute, sublicense, and/or
  sell copies of the Software, and to permit persons to whom the Software is
  furnished to do so, subject to the following conditions:
  The above copyright notice and this permission notice shall be included in
  all copies or substantial portions of the Software.
  THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
  IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
  FITNESS FOR A PARTICULAR PURPOSE AND NON-INFRINGEMENT. IN NO EVENT SHALL THE
  AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
  LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING
  FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS
  IN THE SOFTWARE.
-->

<!-- Main navigation -->
<nav class="md-nav md-nav--primary" data-md-level="0">

  <!-- Site title -->
  <label class="md-nav__title md-nav__title--site" for="__drawer">
    <a href=".."
        title="Protect your IoT Fleet" class="md-nav__button md-logo">
      
        <img src="../assets/images/aws_smile_logo.png" width="48" height="48" />
      
    </a>
    
  </label>

  <!-- Repository containing source -->
  
    <div class="md-nav__source">
      
<a href="https://github.com/aws-samples/protect-your-iot-fleet/" title="Go to repository" class="md-source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M439.55 236.05L244 40.45a28.87 28.87 0 00-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 01-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 000 40.81l195.61 195.6a28.86 28.86 0 0040.8 0l194.69-194.69a28.86 28.86 0 000-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    aws-samples/protect-your-iot-fleet
  </div>
</a>
    </div>
  

  <!-- Render item list -->
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      


  <li class="md-nav__item">
    <a href=".." title="Overview" class="md-nav__link">
      Overview
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../Module%201%3A%20Environment%20build/" title="Module 1: Environment setup" class="md-nav__link">
      Module 1: Environment setup
    </a>
  </li>

    
      
      
      

  


  <li class="md-nav__item md-nav__item--active">
    
    <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
    
      
    
    
      <label class="md-nav__link md-nav__link--active" for="__toc">
        Module 2: Audit your IoT Fleet
        <span class="md-nav__icon md-icon">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 9h14V7H3v2m0 4h14v-2H3v2m0 4h14v-2H3v2m16 0h2v-2h-2v2m0-10v2h2V7h-2m0 6h2v-2h-2v2z"/></svg>
        </span>
      </label>
    
    <a href="./" title="Module 2: Audit your IoT Fleet" class="md-nav__link md-nav__link--active">
      Module 2: Audit your IoT Fleet
    </a>
    
      
<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
      </span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#1-audit-your-iot-fleet" class="md-nav__link">
    1. Audit your IoT Fleet
  </a>
  
    <nav class="md-nav" aria-label="1. Audit your IoT Fleet">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#11-check-audit-settings" class="md-nav__link">
    1.1 Check Audit Settings
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#12-start-an-on-demand-audit" class="md-nav__link">
    1.2 Start an On-Demand Audit
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#2-mitigate-noncompliant-findings" class="md-nav__link">
    2. Mitigate noncompliant findings
  </a>
  
    <nav class="md-nav" aria-label="2. Mitigate noncompliant findings">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#21-define-mitigation-actions" class="md-nav__link">
    2.1 Define mitigation actions
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#22-apply-mitigation-actions-to-noncompliant-findings" class="md-nav__link">
    2.2 Apply mitigation actions to noncompliant findings
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
    
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../Module%203%3A%20Detect%20a%20compromised%20device%20using%20cloud-side%20metrics/" title="Module 3: Detect a compromised device using cloud-side metrics" class="md-nav__link">
      Module 3: Detect a compromised device using cloud-side metrics
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../Module%204%3A%20Detect%20a%20compromised%20device%20using%20device-side%20metrics/" title="Module 4: Detect a compromised device using device-side metrics" class="md-nav__link">
      Module 4: Detect a compromised device using device-side metrics
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../Module%205%3A%20Send%20security%20alerts%20to%20your%20favourite%20messaging%20platform/" title="Module 5: Send security alerts to your favourite messaging platform" class="md-nav__link">
      Module 5: Send security alerts to your favourite messaging platform
    </a>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
      </span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#1-audit-your-iot-fleet" class="md-nav__link">
    1. Audit your IoT Fleet
  </a>
  
    <nav class="md-nav" aria-label="1. Audit your IoT Fleet">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#11-check-audit-settings" class="md-nav__link">
    1.1 Check Audit Settings
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#12-start-an-on-demand-audit" class="md-nav__link">
    1.2 Start an On-Demand Audit
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#2-mitigate-noncompliant-findings" class="md-nav__link">
    2. Mitigate noncompliant findings
  </a>
  
    <nav class="md-nav" aria-label="2. Mitigate noncompliant findings">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#21-define-mitigation-actions" class="md-nav__link">
    2.1 Define mitigation actions
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#22-apply-mitigation-actions-to-noncompliant-findings" class="md-nav__link">
    2.2 Apply mitigation actions to noncompliant findings
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                  <a href="https://github.com/aws-samples/protect-your-iot-fleet/edit/master/docs/Module 2: Audit your IoT Fleet/README.md" title="Edit this page" class="md-content__button md-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20.71 7.04c.39-.39.39-1.04 0-1.41l-2.34-2.34c-.37-.39-1.02-.39-1.41 0l-1.84 1.83 3.75 3.75M3 17.25V21h3.75L17.81 9.93l-3.75-3.75L3 17.25z"/></svg>
                  </a>
                
                
                  
                
                
                <h1 id="module-2-audit-your-iot-fleet">Module 2: Audit your IoT Fleet</h1>
<p>In Module 1, you validated the environment setup for your IoT devices. Your next task is to regularly audit these devices to detect any drifts from security requirements for device configuration. As a busy Security Engineer, you are looking for the opportunity to automate the migration and auditing of thousands of IoT devices. This module will show you how to accomplish automation for audit and mitigation actions.</p>
<ol>
<li>
<p><a href="#1-audit-your-iot-fleet">Audit your IoT Fleet</a></p>
<p>1.1 <a href="#11-check-audit-settings">Check Audit settings</a></p>
<p>1.2 <a href="#12-start-an-on-demand-audit">Start an On-Demand Audit</a></p>
</li>
<li>
<p><a href="#2-mitigate-noncompliant-findings">Mitigate noncompliant findings</a></p>
<p>2.1 <a href="#21-define-mitigation-actions">Define mitigation actions</a></p>
<p>2.2 <a href="#22-apply-mitigation-actions-to-noncompliant-findings">Apply mitigation actions to noncompliant findings</a></p>
</li>
</ol>
<h2 id="1-audit-your-iot-fleet">1. Audit your IoT Fleet</h2>
<p>AWS provides a service called AWS IoT Device Defender to help you look at your account and device settings to ensure security measures are in place. Device Defender provides a feature called <code>Audit</code>. An <code>Audit</code> can help you detect any drift from security best practices or access policies.</p>
<p><code>Audit</code> provides <a href="https://docs.aws.amazon.com/iot/latest/developerguide/device-defender-audit-checks.html">14 type of checks</a>. You can configure audit settings in your AWS account to choose which checks will be available when you set up audits. These Settings are effective at regional level. That means, settings in region A will not affect region B. </p>
<p>An Audit Settings has 3 parts:</p>
<ul>
<li>Service permissions: you will need to allow Device Defender to run Audit against your IoT devices. You do so by using an IAM policies to manage permissions.</li>
<li>Enable Audit checks: you select checks to make it available for audits. You can enable or disable these at  anytime. Disabling a check means that Device Defender will not include that type of check when it runs an Audit.</li>
<li>SNS alerts: This optional setting lets you choose a SNS topic to receive alerts from Device Defender. Alerts are always displayed in the AWS IoT console.</li>
</ul>
<h3 id="11-check-audit-settings">1.1 Check Audit Settings</h3>
<p>In this module, you will run all of the checks for your IoT devices. You will need to validate if all checks are enabled in settings. Leave all the checks enabled. Depending on the scenerio below, expand one of the following dropdowns to start.</p>
<details><summary>Option 1: Click here if you're at an AWS event where the Event Engine is being used or you ran the CloudFormation template in Module 1 in your AWS account</summary><br>

   1. If you are at an AWS Sponsored event, an on-demand Audit was created in advanced for you to make sure you can see what Audit results look like if you can't create an Audit during the event. Thus Audit Settings are already created for you. You can follow steps below to validate Settings

   2. Sign in to AWS Account. From the AWS console home, click **IoT Device Defender** to go to IoT console. (You can search this service in the search box if you don't see it)

   3. On the left side, click **Defend, Settings** to view current settings 

   4. Under **Service permissions**, you will see an IAM role in a format [CloudFormation-stack-name]-IoTAuditRole-[random-value] that gives permission to Device Defender to run audits. This role was create in advance for you using CloudFormation. This IAM role has 1 AWS managed policy **AWSIoTDeviceDefenderAudit** attached to it. Here is what this role looks like in IAM console:

   <img src="../images/auditrole.png"/>

   5. Under **Enable Audit checks**, you will see the list of enabled checks, severity of each checks, and what resources this checks will audit against. Click on the question mark next to the check name to learn more what it does. 

   6. To disable any checks, click on the box next to it and click **Disable**. For example, this is what it looks like when you disable 'Logging disabled' and 'CA certificate expiring' check:

   <img src="../images/disablecheck.png"/>

   7. Disabled checks will be listed under **Disabled Audit checks session**. To enable the checks again, check the box next to check name and click **Enable**

   7. The final section of Settings is **SNS alerts**. You need to enable SNS alerts to receive audit related alerts from Device Defender. Click on **Edit, Enabled**

   8. Under **Topic**, select SNS topic **BadIoTDevices-<YourCFNStackName>** create previously in [Module 1](/Module%201:%20Environment%20build#available-resources). 

   9. Under **Role**, select IAM role with this naming convention [CloudFormation-stack-name]-SNSTopicRole-[random-value]. This role is create by CloudFormation. It has one AWS managed policy **AWSIoTDeviceDefenderPublishFindingsToSNSMitigationAction** 

   10. When you're ready, click **Update** to enable SNS alerts. Don't forget to subscribe to this SNS topic to receive noncompliant findings notification when an Audit completes

    <img src="../images/snsrole.png"/>

   You have completed checking setting for Device Defender Audit. Go to next session **1.2 Start an On-Demand Audit** to create and start an Audit.

</details>

<details><summary>Option 2: Click here if you manually configure Audit Settings very first time</summary><br>

If you finished Module 1 before working on this module, an on-demand Device Defender Audit was created in advance. This option will not be suitable for you.

Device Defender will prompt you to configure Audit Settings if this is the first time you [run an Audit](https://docs.aws.amazon.com/iot/latest/developerguide/device-defender-HowToProceed.html). To use AWS IoT console to start an Audit, follow these steps:

1. Sign in to AWS Account. From AWS console home, click on IoT Device Defender to go to IoT console

2. On the left side of IoT console, click **Defend, Audit, Get started with an audit**

3. You will go through 3 steps to configure settings for Device Defender Audit. Click **Next** to start first steps **Review permissions**

   <img src="../images/firstaudit1.png"/>

4. In this step, you need to grant Device Defender Audits permisison to run audit against your IoT resources and policies by using IAM Role. This IAM role needs to have AWS managed policy **AWSIoTDeviceDefenderAudit**. You can create this IAM role in advance or click **Create Role** so that Device Defender can create the role for you. Click **Next** to go to **Select checks**

5. Select the checks you want to enable, and click **Next** to go to the next step, **Configure SNS**

6. This optional step let you choose which SNS topic will receive alerts from Device Defender. If you choose **Enabled**, you need to provide SNS topic name and IAM role that allow Device Defender to send alerts to that SNS topic. This IAM role needs to have AWS managed policy **AWSIoTDeviceDefenderPublishFindingsToSNSMitigationAction**.

7. Click **Enable Audit** to start your very first Audit. Note that this first Audit is a daily audit - meaning it will run every day at specific time decided by Device Defender. To create different type of Audit (on-demand, monthly,...), click **Defend, Audit, Schedules, Create**

</details>

<h3 id="12-start-an-on-demand-audit">1.2 Start an On-Demand Audit</h3>
<p>When you create a new Audit, you can choose how often the audit should run:</p>
<ul>
<li>On-Demand: Audit starts immediately with no repeats. This option is helpful for ad-hoc audit.</li>
<li>Daily: scheduled audit runs every day. The actual start time of each audit is determined by the system.</li>
<li>Weekly: scheduled audit runs every week on the day of your choice. The actual start time of each audit is determined by the system.</li>
<li>Bi-Weekly: scheduled audit runs every two week on the day of your choice. The actual start time of each audit is determined by the system.</li>
<li>Monthly: scheduled audit runs every month on the day of your choice. The actual start time of each audit is determined by the system.</li>
</ul>
<p>To start an audit immediately, you create an On-Demand Audit by following these steps:</p>
<ul>
<li>
<p>Sign in to AWS Account. From AWS console home, search for <strong>IoT Device Defender</strong> and click on it to go to IoT console</p>
</li>
<li>
<p>From the IoT console, click <strong>Defend</strong>, <strong>Audit</strong>, <strong>Schedules</strong>. Click <strong>Create</strong> button on the top right to create a new Audit. </p>
</li>
<li>
<p>You will see the list of eligible checks can be included in this Audit. If you disable any checks in Audit Settings, you will not see that checks in this list. In this workshop, you select all of the checks (should be 14 checks in total)</p>
</li>
</ul>
<p><img src="../images/Auditlist.png" width="600" height="557"/></p>
<ul>
<li>Click the drop down list under <strong>Set schedule</strong>. Choose <strong>Run audit now(once)</strong>. Then click <strong>Create</strong> to start the Audit immediately. Note that there is no option to name an On-Demand Audit. </li>
</ul>
<p><img src="../images/Auditschedule.png"/></p>
<ul>
<li>
<p>To view Audit's status, go to <strong>Defend</strong>, <strong>Audit</strong>, <strong>Results</strong>. All On-Demand Audit will have the name On-demand.</p>
</li>
<li>
<p>When Audit completes, Device Defender sends you an email (you need to subscribe to SNS topic in <a href="#1.1-check-audit-settings">session 1.1</a>, Option 1, step 11) To view Audit's results, click on the name of the Audit <strong>On-demand</strong></p>
</li>
</ul>
<p><img src="../images/checkresult.png"/></p>
<ul>
<li>
<p>Under <strong>Non-compliant checks</strong>, you should see 3 noncompliant findings under <strong>Check name</strong>:</p>
</li>
<li>
<p><a href="https://docs.aws.amazon.com/iot/latest/developerguide/audit-chk-device-cert-shared.html">Device certificate shared</a>: indicates multiple, concurrent connections use the same X.509 certificate to authenticate with AWS IoT. Each device should have a unique certificate to authenticate with AWS IoT. When multiple devices use the same certificate, this might indicate that a device has been compromised. Its identity might have been cloned to further compromise the system.</p>
</li>
<li>
<p><a href="https://docs.aws.amazon.com/iot/latest/developerguide/audit-chk-iot-policy-permissive.html">IoT policies overly permissive</a>: indicates an AWS IoT policy gives permissions that are too broad or unrestricted. In general, a policy for a device should grant access to resources associated with just that device and no or very few other devices.</p>
</li>
<li><a href="https://docs.aws.amazon.com/iot/latest/developerguide/audit-chk-logging-disabled.html">Logging disabled</a>: indicates AWS IoT logs are not enabled in Amazon CloudWatch. AWS IoT logs in CloudWatch provide visibility into behaviors in AWS IoT, including authentication failures and unexpected connects and disconnects that might indicate that a device has been compromised.</li>
</ul>
<blockquote>
<p>Helpful tip: <a href="https://docs.aws.amazon.com/iot/latest/developerguide/device-defender-audit-checks.html">this Audit Checks document</a> provides instructions to help you fix noncompliant findings for 14 checks.</p>
</blockquote>
<ul>
<li>
<p>To view which resources associate which each findings, click on the check name. In this module, let's work on fixing  <strong>Device certificate shared</strong>  findings. Click on this finding to find out which device certificate are being shared, and which IoT Things are involved.</p>
</li>
<li>
<p>You will see the Certificate Id that is being shared.</p>
</li>
</ul>
<p><img src="../images/sharedcert.png"/></p>
<ul>
<li>
<p>To find out which IoT Things are sharing this cert, go to <strong>Secure, Certificates</strong>. Click the Certificate Id that you see in previous step to view details of this certificate.</p>
</li>
<li>
<p>Now click on <strong>Things</strong> to view the list of IoT Things are using this certificate</p>
</li>
</ul>
<p><img src="../images/thingswithcert.png"/></p>
<p>Now you know exactly that 3 Things <strong>Thing01, Thing02, Thing03</strong> are using the same X.509 to connect to AWS IoT. This is not a good configuration. Move to the next step to mitigate this noncompliant finding.</p>
<h2 id="2-mitigate-noncompliant-findings">2. Mitigate noncompliant findings</h2>
<p>There are multiple methods to automate remediation for noncompliant IoT devices after running Device Defender Audit. You can write scripts/tools to use AWS CLI/SDK to take actions on noncompliant device when you receive notification from AWS Device Defender. Another option is to use AWS Device Management to push updates/patches to your devices at scale. In this module, we will use a different approach: use Device Defender's Mitigation Actions feature to fix noncompliant devices.</p>
<h3 id="21-define-mitigation-actions">2.1 Define mitigation actions</h3>
<p>AWS IoT Device Defender provides predefined actions for the different audit checks. You need to configure those actions for your AWS account and then apply them to a set of findings. </p>
<ul>
<li>
<p>Sign in to AWS Account. From AWS console home, go to IoT Device Defender.</p>
</li>
<li>
<p>From IoT console, click <strong>Defend</strong>, <strong>Mitigation Actions</strong>. From the top right conner, click <strong>Create</strong> to create a new Mitigation Actions.</p>
</li>
<li>
<p>Provide a name for this action. You can name it <strong>Update-device-certificate</strong>.</p>
</li>
<li>
<p>Now you need to choose which action Device Defender will perfom. Click on the drop down list <strong>Action type</strong> to see the <a href="https://docs.aws.amazon.com/iot/latest/developerguide/device-defender-mitigation-actions.html">list of supported actions</a>. </p>
</li>
<li>
<p>Since we want to remediate noncompliant finding <strong>Device certificate shared</strong>, choose <strong>Update device certificate</strong> action type to deactivate the certificate.</p>
</li>
</ul>
<p><img src="../images/ma-updatedev.png"/></p>
<ul>
<li>
<p>You need to give Device Defender permisison to perform this mitigation action. Under <strong>Permission</strong>, expand <strong>Permissions</strong> and <strong>Trust relationships</strong> to look at what permission and trust relationship is required.</p>
</li>
<li>
<p>To create a new IAM role with these permisison, you need to create a new one. Click <strong>Create Role</strong> and enter a role name. Then click <strong>Create role</strong>.  This role will have AWS managed policy <strong>AWSIoTDeviceDefenderAddThingsToThingGroupMitigationAction</strong></p>
</li>
</ul>
<p><img src="../images/ma-permission.png"/></p>
<ul>
<li>
<p>Under <strong>Parameters</strong>, you should see <strong>Deactivate</strong> is choosen as the action Device Defender should take. Note: currently Action Type Update device certificate only has one Action - Deactivate. </p>
</li>
<li>
<p>Leave everything else as it is and click <strong>Save</strong>. </p>
</li>
</ul>
<p>Now we can apply this mitigation actions to the audit findings.</p>
<h3 id="22-apply-mitigation-actions-to-noncompliant-findings">2.2 Apply mitigation actions to noncompliant findings</h3>
<p>After we define mitigation actions for Device Defender, you need to apply these actions to noncompliant findings, so that Device Defender can start remediation.</p>
<ul>
<li>
<p>From left side of IoT console, navigate to <strong>Audit</strong>, <strong>Results</strong>. </p>
</li>
<li>
<p>You should see multiple On-demand audit results. The latest audit should be the one you started on <a href="#1.2-start-an-on-demand-audit">step 1.2 Start an On-Demand Audit</a>. Click on this <strong>On-demand</strong> audit to view the list of findings.</p>
</li>
<li>
<p>Under <strong>Non-compliant checks</strong>, click on <strong>Device certificate shared</strong> to go to findings details. You should see the cerfiticate ID associated to this finding.</p>
</li>
<li>
<p>To apply mitigation actions, check the box next to finding ID, and click <strong>Start Mitigation Action</strong> on the top right corner.</p>
</li>
</ul>
<p><img src="../images/startma.png"/></p>
<ul>
<li>Give a name for this task, then click <strong>Select options for IoT policies overly permissive</strong> to see the drop down lists of actions, and choose the mitigation action you created in the previous step. Then click <strong>Confirm</strong></li>
</ul>
<p><img src="../images/choosema.png"/></p>
<ul>
<li>
<p>To view the status of mitigation actions task, click on <strong>Defend</strong>, <strong>Action results</strong> </p>
</li>
<li>
<p>Since we use mitigation action <strong>Update device certificate</strong>, Device Defender will deactivate the Certificate. </p>
</li>
<li>
<p>To double check, go to <strong>Secure</strong>, <strong>Certificates</strong>. You should see the certificate is <strong>Inactivate</strong>.</p>
</li>
</ul>
<p><img src="../images/inactivecert.png"/></p>
<p><strong>Note: If you will work on next module <a href="../Module%203:%20Detect%20a%20compromised%20device%20using%20cloud-side%20metrics">Module 3: Detect a compromised device using cloud-side metrics</a>, then you will need to re-activate this certificate.</strong></p>
<p>Congratulations! You have mitigated a noncompliant findings in your device configuration. Your next task is to detect if a devices are being used for wrong purpose (for example, particiate in a DDoS attack). Move to <a href="../Module%203:%20Detect%20a%20compromised%20device%20using%20cloud-side%20metrics">Module 3: Detect a compromised device using cloud-side metrics</a> to learn what you can do to accomplish this task.</p>
                
              
              
                


              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid" aria-label="Footer">
        
          <a href="../Module%201%3A%20Environment%20build/" title="Module 1: Environment setup" class="md-footer-nav__link md-footer-nav__link--prev" rel="prev">
            <div class="md-footer-nav__button md-icon">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
            </div>
            <div class="md-footer-nav__title">
              <div class="md-ellipsis">
                <span class="md-footer-nav__direction">
                  Previous
                </span>
                Module 1: Environment setup
              </div>
            </div>
          </a>
        
        
          <a href="../Module%203%3A%20Detect%20a%20compromised%20device%20using%20cloud-side%20metrics/" title="Module 3: Detect a compromised device using cloud-side metrics" class="md-footer-nav__link md-footer-nav__link--next" rel="next">
            <div class="md-footer-nav__title">
              <div class="md-ellipsis">
                <span class="md-footer-nav__direction">
                  Next
                </span>
                Module 3: Detect a compromised device using cloud-side metrics
              </div>
            </div>
            <div class="md-footer-nav__button md-icon">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4z"/></svg>
            </div>
          </a>
        
      </nav>
    </div>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
          <div class="md-footer-copyright__highlight">
            &copy; 2020, Amazon Web Services, Inc. or its affiliates. All rights reserved.
          </div>
        
        Made with
        <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
          Material for MkDocs
        </a>
      </div>
      
  <div class="md-footer-social">
    
      
      
        
        
      
      <a href="https://awssecworkshops.com" target="_blank" rel="noopener" title="awssecworkshops.com" class="md-footer-social__link">
        
      </a>
    
      
      
        
        
      
      <a href="https://aws.amazon.com/security/" target="_blank" rel="noopener" title="aws.amazon.com" class="md-footer-social__link">
        
      </a>
    
      
      
        
        
      
      <a href="https://twitter.com/awssecurityinfo?lang=en" target="_blank" rel="noopener" title="twitter.com" class="md-footer-social__link">
        
      </a>
    
      
      
        
        
      
      <a href="https://aws.amazon.com/blogs/security/" target="_blank" rel="noopener" title="aws.amazon.com" class="md-footer-social__link">
        
      </a>
    
  </div>

    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../assets/javascripts/vendor.c3dc8c49.min.js"></script>
      <script src="../assets/javascripts/bundle.f9edbbd5.min.js"></script><script id="__lang" type="application/json">{"clipboard.copy": "Copy to clipboard", "clipboard.copied": "Copied to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.result.placeholder": "Type to start searching", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents"}</script>
      
      <script>
        app = initialize({
          base: "..",
          features: [],
          search: Object.assign({
            worker: "../assets/javascripts/worker/search.8e2cddea.min.js"
          }, typeof search !== "undefined" && search)
        })
      </script>
      
    
  </body>
</html>