


<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="Before deploying IoT Devices into production environment, it is crucial to have a strategy to identity potential security risks, and to respond quickly to the problem. This session shows you how to address security risks when managing IoT devices at scale. Using AWS IoT Device Defender, you audit device configuration and permission to ensure that desired security settings are in place. Next, you use cloud-side metrics provided by AWS IoT to detect unusual behaviors that could be coming from a compromised device. Finally, you implement solutions to take actions on these devices, using Device Defender Mitigation Actions, and AWS Lambda.">
      
      
      
        <meta name="author" content="aws-security-workshops@amazon.com">
      
      <link rel="shortcut icon" href="../docs/assets/images/aws-favicon.ico">
      <meta name="generator" content="mkdocs-1.1.2, mkdocs-material-5.5.3">
    
    
      
        <title>Module 5: Send security alerts to your favourite messaging platform - Protect your IoT Fleet</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.947af8d5.min.css">
      
      
    
    
    
      
        <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700%7CRoboto+Mono&display=fallback">
        <style>body,input{font-family:"Roboto",-apple-system,BlinkMacSystemFont,Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono",SFMono-Regular,Consolas,Menlo,monospace}</style>
      
    
    
    
      <link rel="stylesheet" href="../stylesheets/custom.css">
    
    
      
    
    
  </head>
  
  
    <body dir="ltr">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#module-5-send-security-alerts-to-your-favourite-messaging-platform" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
      <!--
  Copyright (c) 2016-2018 Martin Donath <martin.donath@squidfunk.com>
  Permission is hereby granted, free of charge, to any person obtaining a copy
  of this software and associated documentation files (the "Software"), to
  deal in the Software without restriction, including without limitation the
  rights to use, copy, modify, merge, publish, distribute, sublicense, and/or
  sell copies of the Software, and to permit persons to whom the Software is
  furnished to do so, subject to the following conditions:
  The above copyright notice and this permission notice shall be included in
  all copies or substantial portions of the Software.
  THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
  IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
  FITNESS FOR A PARTICULAR PURPOSE AND NON-INFRINGEMENT. IN NO EVENT SHALL THE
  AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
  LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING
  FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS
  IN THE SOFTWARE.
-->

<!-- Application header -->
<header class="md-header" data-md-component="header">

    <!-- Top-level navigation -->
    <nav class="md-header-nav md-grid">
      <div class="md-flex">
  
        <!-- Link to home -->
        <div class="md-flex__cell md-flex__cell--shrink">
          <a href="https://aws.amazon.com/"
              title="Amazon Web Services"
              class="md-header-nav__button md-logo">
            
              <img src="../assets/images/aws_smile_logo.png" width="40" height="24" />
            
          </a>
        </div>
  
        <!-- Button to toggle drawer -->
        <div class="md-flex__cell md-flex__cell--shrink">
          <label class="md-icon md-icon--menu md-header-nav__button"
              for="__drawer"></label>
        </div>
  
        <!-- Header title -->
        <div class="md-flex__cell md-flex__cell--stretch">
          <div class="md-flex__ellipsis md-header-nav__title"
              data-md-component="title">
            
              
                <span class="md-header-nav__topic">
                  Protect your IoT Fleet
                </span>
                <span class="md-header-nav__topic">
                  Module 5: Send security alerts to your favourite messaging platform
                </span>
              
            
          </div>
        </div>
        
        
        <!-- Button to open search dialogue -->
        <!--
        <div class="md-flex__cell md-flex__cell--shrink">
          
            
              <label class="md-icon md-icon--search md-header-nav__button"
                  for="__search"></label>
  
              
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" data-md-state="active">
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0116 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 019.5 16 6.5 6.5 0 013 9.5 6.5 6.5 0 019.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
      </label>
      <button type="reset" class="md-search__icon md-icon" aria-label="Clear" data-md-component="search-reset" tabindex="-1">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg>
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
            
          
        </div>

         -->
         
         <div class="md-flex__cell md-flex__cell--shrink">
            <div class="md-flex__ellipsis md-header-nav__lang">
                <div>
                    <button onclick="window.location.href = 'https://awssecworkshops.com/';" class="md-lang-dropbtn fa fa-home"></button>
                </div>
            </div>
        </div>
  
        <!-- Repository containing source -->
        
          <div class="md-flex__cell md-flex__cell--shrink">
            <div class="md-header-nav__source">
              
<a href="https://github.com/aws-samples/protect-your-iot-fleet/" title="Go to repository" class="md-source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M439.55 236.05L244 40.45a28.87 28.87 0 00-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 01-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 000 40.81l195.61 195.6a28.86 28.86 0 0040.8 0l194.69-194.69a28.86 28.86 0 000-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    aws-samples/protect-your-iot-fleet
  </div>
</a>
            </div>
          </div>
        
      </div>
    </nav>
  </header>
    
    <div class="md-container" data-md-component="container">
      
        
      
      
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <!--
  Copyright (c) 2016-2019 Martin Donath <martin.donath@squidfunk.com>
  Permission is hereby granted, free of charge, to any person obtaining a copy
  of this software and associated documentation files (the "Software"), to
  deal in the Software without restriction, including without limitation the
  rights to use, copy, modify, merge, publish, distribute, sublicense, and/or
  sell copies of the Software, and to permit persons to whom the Software is
  furnished to do so, subject to the following conditions:
  The above copyright notice and this permission notice shall be included in
  all copies or substantial portions of the Software.
  THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
  IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
  FITNESS FOR A PARTICULAR PURPOSE AND NON-INFRINGEMENT. IN NO EVENT SHALL THE
  AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
  LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING
  FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS
  IN THE SOFTWARE.
-->

<!-- Main navigation -->
<nav class="md-nav md-nav--primary" data-md-level="0">

  <!-- Site title -->
  <label class="md-nav__title md-nav__title--site" for="__drawer">
    <a href=".."
        title="Protect your IoT Fleet" class="md-nav__button md-logo">
      
        <img src="../assets/images/aws_smile_logo.png" width="48" height="48" />
      
    </a>
    
  </label>

  <!-- Repository containing source -->
  
    <div class="md-nav__source">
      
<a href="https://github.com/aws-samples/protect-your-iot-fleet/" title="Go to repository" class="md-source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M439.55 236.05L244 40.45a28.87 28.87 0 00-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 01-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 000 40.81l195.61 195.6a28.86 28.86 0 0040.8 0l194.69-194.69a28.86 28.86 0 000-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    aws-samples/protect-your-iot-fleet
  </div>
</a>
    </div>
  

  <!-- Render item list -->
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      


  <li class="md-nav__item">
    <a href=".." title="Overview" class="md-nav__link">
      Overview
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../Module%201%3A%20Environment%20build/" title="Module 1: Environment setup" class="md-nav__link">
      Module 1: Environment setup
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../Module%202%3A%20Audit%20your%20IoT%20Fleet/" title="Module 2: Audit your IoT Fleet" class="md-nav__link">
      Module 2: Audit your IoT Fleet
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../Module%203%3A%20Detect%20a%20compromised%20device%20using%20cloud-side%20metrics/" title="Module 3: Detect a compromised device using cloud-side metrics" class="md-nav__link">
      Module 3: Detect a compromised device using cloud-side metrics
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../Module%204%3A%20Detect%20a%20compromised%20device%20using%20device-side%20metrics/" title="Module 4: Detect a compromised device using device-side metrics" class="md-nav__link">
      Module 4: Detect a compromised device using device-side metrics
    </a>
  </li>

    
      
      
      

  


  <li class="md-nav__item md-nav__item--active">
    
    <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
    
      
    
    
      <label class="md-nav__link md-nav__link--active" for="__toc">
        Module 5: Send security alerts to your favourite messaging platform
        <span class="md-nav__icon md-icon">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 9h14V7H3v2m0 4h14v-2H3v2m0 4h14v-2H3v2m16 0h2v-2h-2v2m0-10v2h2V7h-2m0 6h2v-2h-2v2z"/></svg>
        </span>
      </label>
    
    <a href="./" title="Module 5: Send security alerts to your favourite messaging platform" class="md-nav__link md-nav__link--active">
      Module 5: Send security alerts to your favourite messaging platform
    </a>
    
      
<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
      </span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#1-send-sms-message-to-your-phone-only-available-in-region-that-supports-sms-messaging" class="md-nav__link">
    1. Send SMS message to your phone (only available in region that supports SMS messaging):
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#2-receive-alerts-on-chime-chatroom" class="md-nav__link">
    2. Receive alerts on Chime chatroom
  </a>
  
    <nav class="md-nav" aria-label="2. Receive alerts on Chime chatroom">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#21-configure-chime-webhook" class="md-nav__link">
    2.1 Configure Chime Webhook
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#22-create-deployment-package-for-lambda-function" class="md-nav__link">
    2.2 Create deployment package for Lambda function
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#23-configure-lambda-function" class="md-nav__link">
    2.3 Configure Lambda function
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#3-receive-alerts-on-slack-channel" class="md-nav__link">
    3. Receive alerts on Slack channel
  </a>
  
    <nav class="md-nav" aria-label="3. Receive alerts on Slack channel">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#31-create-a-slack-incoming-webhook" class="md-nav__link">
    3.1 Create a Slack Incoming WebHook
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#32-create-lambda-function-to-post-messages-to-slack" class="md-nav__link">
    3.2 Create Lambda function to post messages to Slack
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#4-test-alerts" class="md-nav__link">
    4. Test alerts
  </a>
  
</li>
      
    </ul>
  
</nav>
    
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
      </span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#1-send-sms-message-to-your-phone-only-available-in-region-that-supports-sms-messaging" class="md-nav__link">
    1. Send SMS message to your phone (only available in region that supports SMS messaging):
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#2-receive-alerts-on-chime-chatroom" class="md-nav__link">
    2. Receive alerts on Chime chatroom
  </a>
  
    <nav class="md-nav" aria-label="2. Receive alerts on Chime chatroom">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#21-configure-chime-webhook" class="md-nav__link">
    2.1 Configure Chime Webhook
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#22-create-deployment-package-for-lambda-function" class="md-nav__link">
    2.2 Create deployment package for Lambda function
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#23-configure-lambda-function" class="md-nav__link">
    2.3 Configure Lambda function
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#3-receive-alerts-on-slack-channel" class="md-nav__link">
    3. Receive alerts on Slack channel
  </a>
  
    <nav class="md-nav" aria-label="3. Receive alerts on Slack channel">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#31-create-a-slack-incoming-webhook" class="md-nav__link">
    3.1 Create a Slack Incoming WebHook
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#32-create-lambda-function-to-post-messages-to-slack" class="md-nav__link">
    3.2 Create Lambda function to post messages to Slack
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#4-test-alerts" class="md-nav__link">
    4. Test alerts
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                  <a href="https://github.com/aws-samples/protect-your-iot-fleet/edit/master/docs/Module 5: Send security alerts to your favourite messaging platform/README.md" title="Edit this page" class="md-content__button md-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20.71 7.04c.39-.39.39-1.04 0-1.41l-2.34-2.34c-.37-.39-1.02-.39-1.41 0l-1.84 1.83 3.75 3.75M3 17.25V21h3.75L17.81 9.93l-3.75-3.75L3 17.25z"/></svg>
                  </a>
                
                
                  
                
                
                <h1 id="module-5-send-security-alerts-to-your-favourite-messaging-platform">Module 5: Send security alerts to your favourite messaging platform</h1>
<p>For many Security Engineers, receiving alerts in real time is critical. They need to act quickly to reduce impact of security issues. SMS message, or messaging platform such as Slack or Chime, are common tools to notify engineers when thing goes wrong.</p>
<p>In this extra-credit module, you configure SNS to send Device Defender alerts to your phone, Amazon Chime chatroom, or Slack channel.</p>
<blockquote>
<p>Note: you need to have a SNS topic receives alerts from Device Defender to work on this module</p>
</blockquote>
<ol>
<li><a href="#1-send-sms-message-to-your-phone-only-available-in-region-that-supports-sms-messaging">Send SMS message to your phone</a></li>
<li><a href="#2-receive-alerts-on-chime-chatroom">Receive alerts on Chime chatroom</a></li>
<li><a href="#3-receive-alerts-on-slack-channel">Receive alerts on Slack channel</a></li>
<li><a href="#4-test-alerts">Test Alerts</a></li>
</ol>
<h2 id="1-send-sms-message-to-your-phone-only-available-in-region-that-supports-sms-messaging">1. Send SMS message to your phone (only available in <a href="https://docs.aws.amazon.com/sns/latest/dg/sns-supported-regions-countries.html">region that supports SMS messaging</a>):</h2>
<p>You can subcribe your phone number to SNS topic receive alerts from IoT Device Defender. When a new alert occurs, SNS will send you a SMS message (SMS cost will be charged)</p>
<ul>
<li>
<p>Sign in to your AWS account. From AWS console home, click <strong>SNS</strong></p>
</li>
<li>
<p>On the left hand side, click on menu bar to show the list of SNS features. Click <strong>Subscriptions</strong></p>
</li>
<li>
<p>Choose SNS topic that you use to receive alerts from IoT Device Defender. Choose <strong>SMS</strong> as protocal. Type in your phone number in <strong>EndPoint</strong>. Click <strong>Create subscription</strong></p>
</li>
</ul>
<p><img src="../images/snssub.png"/></p>
<p>You will need to confirm your subscription in order to start receiving SMS message.</p>
<p>Now you can move to <a href="#4-test-alerts">Test Alerts</a> to test out this new intergration</p>
<h2 id="2-receive-alerts-on-chime-chatroom">2. Receive alerts on Chime chatroom</h2>
<p>Amazon Chime is a communication tool that lets you chat and place calls. Chime provide a feature call Incoming Webhook to allow applications post message to Chime chatroom. You can configure SNS to send a message to your Chime chatroom when Device Defender generates an alert.</p>
<h3 id="21-configure-chime-webhook">2.1 Configure Chime Webhook</h3>
<p>If you don't have a chat room, you can create a new one. From Chime App, click <strong>Rooms, Create a chat room, Done</strong>
Click on the gear icon top right of the chat room. Then click <strong>Manage webhooks and bots</strong>. </p>
<p>Click <strong>Add webhook</strong> and give it a name. Your webhook will have a unique URL e.g. https://hooks.chime.aws/incomingwebhooks/<guid>?token=xxxxxxxxxxxxxxxxxxxx). You need to protect this URL just as you protect any secret materials (API keys, username-password,..) because anyone has this URL can post a message to your chat room. Copy this URL and save it in a touchpad. You will need this URL to config Lamdbda function in step 2.2</p>
<h3 id="22-create-deployment-package-for-lambda-function">2.2 Create deployment package for Lambda function</h3>
<p>Since SNS doesn't intergrate with Chime directly, we will use a Lambda function to post the SNS message to the Chime chatroom. You will need to create a deployment package for this Lambda function by following these steps:</p>
<p>a. Clone this workshop github repo, change directory to 'Module 5: Send security alerts to your favourite messaging platform', navigate to folder 'LambdaWebhookChime'. This folder should only have a python script index.py at the moment.</p>
<p>b. We will install neccessary dependecies for this python script. Under device folder, create a subfolder called Package. </p>
<div class="codehilite"><pre><span></span><code><span class="err">        mkdir Package</span>
<span class="err">        cd Package</span>
</code></pre></div>


<p>c. Install these dependencies, choose Package as target folder. </p>
<div class="codehilite"><pre><span></span><code><span class="err">        pip install --target . requests</span>
</code></pre></div>


<p>d. Create a zip archive of the dependencies named webhookchime.zip in Package and store it in LambdaWebhookChime folder. Run this command when you currently in Package folder</p>
<div class="codehilite"><pre><span></span><code><span class="err">  zip -r9 ../webhookchime.zip .</span>
</code></pre></div>


<p>e. Add python script device.py to the archive</p>
<div class="codehilite"><pre><span></span><code><span class="err">  cd ..</span>
<span class="err">  zip -g webhookchime.zip index.py</span>
</code></pre></div>


<p>f. You will upload this zip file when you create lambda function next step</p>
<h3 id="23-configure-lambda-function">2.3 Configure Lambda function</h3>
<p>From Lambda management console, create a new Lambda function. Give this new function a name and choose Python3.* as runtime with default permissions. </p>
<p>Now we already write the code for this lambda function and install all dependencies in previous step. Upload this deploymet packages webhookchime.zip to the Lambda function. Under <strong>Function code</strong>, click the drop down <strong>Code entry type</strong>, and choose <strong>Upload a .zip file</strong>. Make sure the function hander is 'index.handler'. Here is the code snippet of this Lambda function</p>
<div class="codehilite"><pre><span></span><code><span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">boto3</span>
<span class="kn">import</span> <span class="nn">requests</span>
<span class="kn">from</span> <span class="nn">base64</span> <span class="kn">import</span> <span class="n">b64decode</span>

<span class="k">def</span> <span class="nf">get_message</span><span class="p">(</span><span class="n">event</span><span class="p">):</span>
  <span class="k">try</span><span class="p">:</span>
    <span class="n">message</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">event</span><span class="p">[</span><span class="s1">&#39;Records&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;Sns&#39;</span><span class="p">][</span><span class="s1">&#39;Message&#39;</span><span class="p">])</span> 
    <span class="n">thing</span> <span class="o">=</span> <span class="s1">&#39;Thing name: &#39;</span> <span class="o">+</span> <span class="n">message</span><span class="p">[</span><span class="s1">&#39;thingName&#39;</span><span class="p">]</span>
    <span class="n">securityprofile</span> <span class="o">=</span> <span class="s1">&#39;Security profile: &#39;</span> <span class="o">+</span> <span class="n">message</span><span class="p">[</span><span class="s1">&#39;securityProfileName&#39;</span><span class="p">]</span>
    <span class="n">behaviorname</span> <span class="o">=</span> <span class="s1">&#39;Behavior name: &#39;</span> <span class="o">+</span> <span class="n">message</span><span class="p">[</span><span class="s1">&#39;behavior&#39;</span><span class="p">][</span><span class="s1">&#39;name&#39;</span><span class="p">]</span>
    <span class="k">return</span> <span class="s2">&quot; | &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">thing</span><span class="p">,</span><span class="n">securityprofile</span><span class="p">,</span><span class="n">behaviorname</span><span class="p">])</span>
  <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
    <span class="k">return</span> <span class="s1">&#39;test message&#39;</span>

<span class="k">def</span> <span class="nf">handler</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="n">context</span><span class="p">):</span>
  <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Getting ready to send message to Amazon Chime room&#39;</span><span class="p">)</span>
  <span class="n">content</span> <span class="o">=</span> <span class="s1">&#39;IoT Device Defender alert! </span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">get_message</span><span class="p">(</span><span class="n">event</span><span class="p">))</span>
  <span class="n">webhook_uri</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;CHIME_WEBHOOK&#39;</span><span class="p">]</span>
  <span class="n">requests</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="n">url</span><span class="o">=</span><span class="n">webhook_uri</span><span class="p">,</span> <span class="n">json</span><span class="o">=</span><span class="p">{</span> <span class="s1">&#39;Content&#39;</span><span class="p">:</span> <span class="n">content</span> <span class="p">})</span>
  <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Finished sending notification to Amazon Chime room&#39;</span><span class="p">)</span>
</code></pre></div>


<p>Next create an environment variables to provide Chime Webhook URL to Lamdba function. Scroll to <strong>Environment Variables</strong>. From the right side, click <strong>Edit --&gt; Add environment variables</strong>. Add <strong>CHIME_WEBHOOK</strong> as the Key and provide webhook URL as the Value. Click Save</p>
<p>This function parse the SNS message to retrieve Thing name, Security Profile, and Behavior name, then it use <em>requests</em> method to post these information to the webhook URL. In this lab, we have stored the webhook URL as an environment variable <strong>CHIME_WEBHOOK</strong>. In production use cases, we would recommend to store it securely using AWS Secrets Manager or any existing tools/vault that your team is using.</p>
<p>When you have succcesfully created this Lambda function, let's add SNS as a trigger. Under <strong>Designer</strong>, click <strong>Add trigger</strong> and select <strong>SNS</strong>. Choose the SNS topic that you configured to receive IoT Device Defender alerts in. Remember to check box <strong>Enable trigger</strong>. Then click <strong>Add</strong></p>
<p>Now you can move to <a href="#4-test-alerts">Test Alerts</a> to test out this new intergration</p>
<h2 id="3-receive-alerts-on-slack-channel">3. Receive alerts on Slack channel</h2>
<p>You need to have  a Slack channel in this session. To configure Device Defender send alerts to Slack channel, follow steps below</p>
<h3 id="31-create-a-slack-incoming-webhook">3.1 Create a Slack Incoming WebHook</h3>
<p>Start by setting up an <a href="https://my.slack.com/services/new/incoming-webhook/">incoming webhook integration</a>. Choose the channel that Webhook will post messages to and click <strong>Add Incoming Webhooks integration</strong></p>
<p>Note down the <strong>Webhook URL</strong> and save it in your favourite text editor.</p>
<h3 id="32-create-lambda-function-to-post-messages-to-slack">3.2 Create Lambda function to post messages to Slack</h3>
<p>Sign in to your AWS account. Go to Lambda console and create a Lambda function to post the message to the channel. </p>
<p>Click <strong>Create function</strong>. Select <strong>Author from Scratch</strong>.</p>
<p><img src="../images/lambdaslack.png"/></p>
<p>Name this lambda function. Chose <strong>Python 3.8</strong> for Runtime, and choose <strong>Create a new role with basic Lambda permissions</strong> for Execution Role. Click <strong>Create function</strong></p>
<p>Replace the code in Lambda function with Python code below. You can also download it from <a href="/
LambdaWebhookSlack.py">LambdaWebhookSlack.py</a>. Remember to click Save</p>
<div class="codehilite"><pre><span></span><code><span class="kn">import</span> <span class="nn">boto3</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">os</span>

<span class="kn">from</span> <span class="nn">base64</span> <span class="kn">import</span> <span class="n">b64decode</span>
<span class="kn">from</span> <span class="nn">urllib.request</span> <span class="kn">import</span> <span class="n">Request</span><span class="p">,</span> <span class="n">urlopen</span>
<span class="kn">from</span> <span class="nn">urllib.error</span> <span class="kn">import</span> <span class="n">URLError</span><span class="p">,</span> <span class="n">HTTPError</span>

<span class="c1">#The hook URL of Slcak channel</span>
<span class="n">HOOK_URL</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;slackHookURL&#39;</span><span class="p">]</span>
<span class="c1"># The Slack channel to send a message to stored in the slackChannel environment variable</span>
<span class="n">SLACK_CHANNEL</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;slackChannel&#39;</span><span class="p">]</span>


<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">()</span>
<span class="n">logger</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">lambda_handler</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="n">context</span><span class="p">):</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Event: &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">event</span><span class="p">))</span>
    <span class="n">message</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">event</span><span class="p">[</span><span class="s1">&#39;Records&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;Sns&#39;</span><span class="p">][</span><span class="s1">&#39;Message&#39;</span><span class="p">])</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Message: &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">message</span><span class="p">))</span>

    <span class="n">thing</span> <span class="o">=</span> <span class="s1">&#39;Thing name: &#39;</span> <span class="o">+</span> <span class="n">message</span><span class="p">[</span><span class="s1">&#39;thingName&#39;</span><span class="p">]</span>
    <span class="n">securityprofile</span> <span class="o">=</span> <span class="s1">&#39;Security profile: &#39;</span> <span class="o">+</span> <span class="n">message</span><span class="p">[</span><span class="s1">&#39;securityProfileName&#39;</span><span class="p">]</span>
    <span class="n">behaviorname</span> <span class="o">=</span> <span class="s1">&#39;Behavior name: &#39;</span> <span class="o">+</span> <span class="n">message</span><span class="p">[</span><span class="s1">&#39;behavior&#39;</span><span class="p">][</span><span class="s1">&#39;name&#39;</span><span class="p">]</span>

    <span class="n">slack_message</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;channel&#39;</span><span class="p">:</span> <span class="n">SLACK_CHANNEL</span><span class="p">,</span>
        <span class="s1">&#39;text&#39;</span><span class="p">:</span> <span class="s2">&quot; You have a new Device Defender alert:  </span><span class="si">%s</span><span class="s2">, </span><span class="si">%s</span><span class="s2">, </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">thing</span><span class="p">,</span> <span class="n">securityprofile</span><span class="p">,</span> <span class="n">behaviorname</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="n">req</span> <span class="o">=</span> <span class="n">Request</span><span class="p">(</span><span class="n">HOOK_URL</span><span class="p">,</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">slack_message</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">))</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">urlopen</span><span class="p">(</span><span class="n">req</span><span class="p">)</span>
        <span class="n">response</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Message posted to </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">slack_message</span><span class="p">[</span><span class="s1">&#39;channel&#39;</span><span class="p">])</span>
    <span class="k">except</span> <span class="n">HTTPError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Request failed: </span><span class="si">%d</span><span class="s2"> </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">e</span><span class="o">.</span><span class="n">code</span><span class="p">,</span> <span class="n">e</span><span class="o">.</span><span class="n">reason</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">URLError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Server connection failed: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">e</span><span class="o">.</span><span class="n">reason</span><span class="p">)</span>
</code></pre></div>


<p>Under <strong>Environment variables</strong>, click <strong>Edit</strong> and <strong>Add environment variable</strong>. You need to add two environmen variables <strong>slackHookURL</strong> and <strong>slackChannel</strong>. Provide values for these variables. Then click <strong>Save</strong></p>
<p><img src="../images/envvarslack.png"/></p>
<p>Now add SNS as a trigger for this function. Under <strong>SNS trigger</strong>, choose the SNS topic that Device Defender sends alerts to. From previous modules, a SNS topic <strong>BadIoTDevices-[CloudFormation stackname]</strong> was created. You can use this SNS topic or create a new one. Remember to check box <strong>Enable trigger</strong>. Then click <strong>Add</strong></p>
<blockquote>
<p>Note: we recommend to protect your WebHookURL just like you pretect a password. You can use KMS to encrypt the URL of the webhook, and base-64 encode it before pasting it in to the code. An example can be found in <a href="https://aws.amazon.com/blogs/aws/new-slack-integration-blueprints-for-aws-lambda/">Slack Integration Blueprint for Lambda</a></p>
</blockquote>
<p>Now you can move to <a href="#4-test-alerts">Test Alerts</a> to test out this new intergration</p>
<h2 id="4-test-alerts">4. Test alerts</h2>
<p>To test if notification works, you can publish this test SNS message below using SNS console. This is an example alerts generated by Device Defender.</p>
<ul>
<li>
<p>Sign in to your AWS account, click <strong>SNS</strong> to go to SNS console</p>
</li>
<li>
<p>On the left side, click on menu bar, and click <strong>Topics</strong> to see the list of SNS topics. In this module, select <strong>BadIoTDevices-[CloudFormation stackname]</strong> topic.</p>
</li>
<li>
<p>Click <strong>Publish message</strong> on the top right corner. Copy the json blob below to <strong>Message body to send to the endpoint</strong>. Then click <strong>Publish message</strong></p>
</li>
</ul>
<div class="codehilite"><pre><span></span><code><span class="p">{</span>
  <span class="nt">&quot;violationEventTime&quot;</span><span class="p">:</span> <span class="mi">1582745400000</span><span class="p">,</span>
  <span class="nt">&quot;thingName&quot;</span><span class="p">:</span> <span class="s2">&quot;myIoTDevice&quot;</span><span class="p">,</span>
  <span class="nt">&quot;behavior&quot;</span><span class="p">:</span> <span class="p">{</span>
    <span class="nt">&quot;criteria&quot;</span><span class="p">:</span> <span class="p">{</span>
      <span class="nt">&quot;consecutiveDatapointsToClear&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
      <span class="nt">&quot;value&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="nt">&quot;count&quot;</span><span class="p">:</span> <span class="mi">5000</span>
      <span class="p">},</span>
      <span class="nt">&quot;consecutiveDatapointsToAlarm&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
      <span class="nt">&quot;comparisonOperator&quot;</span><span class="p">:</span> <span class="s2">&quot;greater-than&quot;</span>
    <span class="p">},</span>
    <span class="nt">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;messageSize&quot;</span><span class="p">,</span>
    <span class="nt">&quot;metric&quot;</span><span class="p">:</span> <span class="s2">&quot;aws:message-byte-size&quot;</span>
  <span class="p">},</span>
  <span class="nt">&quot;violationEventType&quot;</span><span class="p">:</span> <span class="s2">&quot;in-alarm&quot;</span><span class="p">,</span>
  <span class="nt">&quot;metricValue&quot;</span><span class="p">:</span> <span class="p">{</span>
    <span class="nt">&quot;count&quot;</span><span class="p">:</span> <span class="mi">26</span>
  <span class="p">},</span>
  <span class="nt">&quot;violationId&quot;</span><span class="p">:</span> <span class="s2">&quot;123456789&quot;</span><span class="p">,</span>
  <span class="nt">&quot;securityProfileName&quot;</span><span class="p">:</span> <span class="s2">&quot;LargeMessageSize&quot;</span>
<span class="p">}</span>
</code></pre></div>


<p>Congratulations! You have succesfully sent Device Defender alerts in real time to your favourite communication tools. </p>
                
              
              
                


              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid" aria-label="Footer">
        
          <a href="../Module%204%3A%20Detect%20a%20compromised%20device%20using%20device-side%20metrics/" title="Module 4: Detect a compromised device using device-side metrics" class="md-footer-nav__link md-footer-nav__link--prev" rel="prev">
            <div class="md-footer-nav__button md-icon">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
            </div>
            <div class="md-footer-nav__title">
              <div class="md-ellipsis">
                <span class="md-footer-nav__direction">
                  Previous
                </span>
                Module 4: Detect a compromised device using device-side metrics
              </div>
            </div>
          </a>
        
        
      </nav>
    </div>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
          <div class="md-footer-copyright__highlight">
            &copy; 2020, Amazon Web Services, Inc. or its affiliates. All rights reserved.
          </div>
        
        Made with
        <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
          Material for MkDocs
        </a>
      </div>
      
  <div class="md-footer-social">
    
      
      
        
        
      
      <a href="https://awssecworkshops.com" target="_blank" rel="noopener" title="awssecworkshops.com" class="md-footer-social__link">
        
      </a>
    
      
      
        
        
      
      <a href="https://aws.amazon.com/security/" target="_blank" rel="noopener" title="aws.amazon.com" class="md-footer-social__link">
        
      </a>
    
      
      
        
        
      
      <a href="https://twitter.com/awssecurityinfo?lang=en" target="_blank" rel="noopener" title="twitter.com" class="md-footer-social__link">
        
      </a>
    
      
      
        
        
      
      <a href="https://aws.amazon.com/blogs/security/" target="_blank" rel="noopener" title="aws.amazon.com" class="md-footer-social__link">
        
      </a>
    
  </div>

    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../assets/javascripts/vendor.c3dc8c49.min.js"></script>
      <script src="../assets/javascripts/bundle.f9edbbd5.min.js"></script><script id="__lang" type="application/json">{"clipboard.copy": "Copy to clipboard", "clipboard.copied": "Copied to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.result.placeholder": "Type to start searching", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents"}</script>
      
      <script>
        app = initialize({
          base: "..",
          features: [],
          search: Object.assign({
            worker: "../assets/javascripts/worker/search.8e2cddea.min.js"
          }, typeof search !== "undefined" && search)
        })
      </script>
      
    
  </body>
</html>