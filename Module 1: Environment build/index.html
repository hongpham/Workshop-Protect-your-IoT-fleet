


<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="Before deploying IoT Devices into production environment, it is crucial to have a strategy to identity potential security risks, and to respond quickly to the problem. This session shows you how to address security risks when managing IoT devices at scale. Using AWS IoT Device Defender, you audit device configuration and permission to ensure that desired security settings are in place. Next, you use cloud-side metrics provided by AWS IoT to detect unusual behaviors that could be coming from a compromised device. Finally, you implement solutions to take actions on these devices, using Device Defender Mitigation Actions, and AWS Lambda.">
      
      
      
        <meta name="author" content="aws-security-workshops@amazon.com">
      
      <link rel="shortcut icon" href="../docs/assets/images/aws-favicon.ico">
      <meta name="generator" content="mkdocs-1.1.2, mkdocs-material-5.5.3">
    
    
      
        <title>Module 1: Environment setup - Protect your IoT Fleet</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.947af8d5.min.css">
      
      
    
    
    
      
        <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700%7CRoboto+Mono&display=fallback">
        <style>body,input{font-family:"Roboto",-apple-system,BlinkMacSystemFont,Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono",SFMono-Regular,Consolas,Menlo,monospace}</style>
      
    
    
    
      <link rel="stylesheet" href="../stylesheets/custom.css">
    
    
      
    
    
  </head>
  
  
    <body dir="ltr">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#module-1-environment-build" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
      <!--
  Copyright (c) 2016-2018 Martin Donath <martin.donath@squidfunk.com>
  Permission is hereby granted, free of charge, to any person obtaining a copy
  of this software and associated documentation files (the "Software"), to
  deal in the Software without restriction, including without limitation the
  rights to use, copy, modify, merge, publish, distribute, sublicense, and/or
  sell copies of the Software, and to permit persons to whom the Software is
  furnished to do so, subject to the following conditions:
  The above copyright notice and this permission notice shall be included in
  all copies or substantial portions of the Software.
  THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
  IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
  FITNESS FOR A PARTICULAR PURPOSE AND NON-INFRINGEMENT. IN NO EVENT SHALL THE
  AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
  LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING
  FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS
  IN THE SOFTWARE.
-->

<!-- Application header -->
<header class="md-header" data-md-component="header">

    <!-- Top-level navigation -->
    <nav class="md-header-nav md-grid">
      <div class="md-flex">
  
        <!-- Link to home -->
        <div class="md-flex__cell md-flex__cell--shrink">
          <a href="https://aws.amazon.com/"
              title="Amazon Web Services"
              class="md-header-nav__button md-logo">
            
              <img src="../assets/images/aws_smile_logo.png" width="40" height="24" />
            
          </a>
        </div>
  
        <!-- Button to toggle drawer -->
        <div class="md-flex__cell md-flex__cell--shrink">
          <label class="md-icon md-icon--menu md-header-nav__button"
              for="__drawer"></label>
        </div>
  
        <!-- Header title -->
        <div class="md-flex__cell md-flex__cell--stretch">
          <div class="md-flex__ellipsis md-header-nav__title"
              data-md-component="title">
            
              
                <span class="md-header-nav__topic">
                  Protect your IoT Fleet
                </span>
                <span class="md-header-nav__topic">
                  Module 1: Environment setup
                </span>
              
            
          </div>
        </div>
        
        
        <!-- Button to open search dialogue -->
        <!--
        <div class="md-flex__cell md-flex__cell--shrink">
          
            
              <label class="md-icon md-icon--search md-header-nav__button"
                  for="__search"></label>
  
              
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" data-md-state="active">
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0116 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 019.5 16 6.5 6.5 0 013 9.5 6.5 6.5 0 019.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
      </label>
      <button type="reset" class="md-search__icon md-icon" aria-label="Clear" data-md-component="search-reset" tabindex="-1">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg>
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
            
          
        </div>

         -->
         
         <div class="md-flex__cell md-flex__cell--shrink">
            <div class="md-flex__ellipsis md-header-nav__lang">
                <div>
                    <button onclick="window.location.href = 'https://awssecworkshops.com/';" class="md-lang-dropbtn fa fa-home"></button>
                </div>
            </div>
        </div>
  
        <!-- Repository containing source -->
        
          <div class="md-flex__cell md-flex__cell--shrink">
            <div class="md-header-nav__source">
              
<a href="https://github.com/aws-samples/protect-your-iot-fleet/" title="Go to repository" class="md-source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M439.55 236.05L244 40.45a28.87 28.87 0 00-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 01-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 000 40.81l195.61 195.6a28.86 28.86 0 0040.8 0l194.69-194.69a28.86 28.86 0 000-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    aws-samples/protect-your-iot-fleet
  </div>
</a>
            </div>
          </div>
        
      </div>
    </nav>
  </header>
    
    <div class="md-container" data-md-component="container">
      
        
      
      
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <!--
  Copyright (c) 2016-2019 Martin Donath <martin.donath@squidfunk.com>
  Permission is hereby granted, free of charge, to any person obtaining a copy
  of this software and associated documentation files (the "Software"), to
  deal in the Software without restriction, including without limitation the
  rights to use, copy, modify, merge, publish, distribute, sublicense, and/or
  sell copies of the Software, and to permit persons to whom the Software is
  furnished to do so, subject to the following conditions:
  The above copyright notice and this permission notice shall be included in
  all copies or substantial portions of the Software.
  THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
  IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
  FITNESS FOR A PARTICULAR PURPOSE AND NON-INFRINGEMENT. IN NO EVENT SHALL THE
  AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
  LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING
  FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS
  IN THE SOFTWARE.
-->

<!-- Main navigation -->
<nav class="md-nav md-nav--primary" data-md-level="0">

  <!-- Site title -->
  <label class="md-nav__title md-nav__title--site" for="__drawer">
    <a href=".."
        title="Protect your IoT Fleet" class="md-nav__button md-logo">
      
        <img src="../assets/images/aws_smile_logo.png" width="48" height="48" />
      
    </a>
    
  </label>

  <!-- Repository containing source -->
  
    <div class="md-nav__source">
      
<a href="https://github.com/aws-samples/protect-your-iot-fleet/" title="Go to repository" class="md-source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M439.55 236.05L244 40.45a28.87 28.87 0 00-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 01-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 000 40.81l195.61 195.6a28.86 28.86 0 0040.8 0l194.69-194.69a28.86 28.86 0 000-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    aws-samples/protect-your-iot-fleet
  </div>
</a>
    </div>
  

  <!-- Render item list -->
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      


  <li class="md-nav__item">
    <a href=".." title="Overview" class="md-nav__link">
      Overview
    </a>
  </li>

    
      
      
      

  


  <li class="md-nav__item md-nav__item--active">
    
    <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
    
      
    
    
      <label class="md-nav__link md-nav__link--active" for="__toc">
        Module 1: Environment setup
        <span class="md-nav__icon md-icon">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 9h14V7H3v2m0 4h14v-2H3v2m0 4h14v-2H3v2m16 0h2v-2h-2v2m0-10v2h2V7h-2m0 6h2v-2h-2v2z"/></svg>
        </span>
      </label>
    
    <a href="./" title="Module 1: Environment setup" class="md-nav__link md-nav__link--active">
      Module 1: Environment setup
    </a>
    
      
<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
      </span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#1-available-resources" class="md-nav__link">
    1. Available resources:
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#2-validate-environment-setup" class="md-nav__link">
    2. Validate environment setup
  </a>
  
    <nav class="md-nav" aria-label="2. Validate environment setup">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#1-check-iot-devices-powered-by-lambda-functions" class="md-nav__link">
    1. Check IoT Devices powered by Lambda functions
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2-check-iot-device-powered-by-cloud9-environment" class="md-nav__link">
    2. Check IoT Device powered by Cloud9 environment
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#3-aws-iot-things" class="md-nav__link">
    3. AWS IoT Things
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#3-check-if-your-devices-are-sending-data-to-aws-iot" class="md-nav__link">
    3. Check if your devices are sending data to AWS IoT
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
    
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../Module%202%3A%20Audit%20your%20IoT%20Fleet/" title="Module 2: Audit your IoT Fleet" class="md-nav__link">
      Module 2: Audit your IoT Fleet
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../Module%203%3A%20Detect%20a%20compromised%20device%20using%20cloud-side%20metrics/" title="Module 3: Detect a compromised device using cloud-side metrics" class="md-nav__link">
      Module 3: Detect a compromised device using cloud-side metrics
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../Module%204%3A%20Detect%20a%20compromised%20device%20using%20device-side%20metrics/" title="Module 4: Detect a compromised device using device-side metrics" class="md-nav__link">
      Module 4: Detect a compromised device using device-side metrics
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../Module%205%3A%20Send%20security%20alerts%20to%20your%20favourite%20messaging%20platform/" title="Module 5: Send security alerts to your favourite messaging platform" class="md-nav__link">
      Module 5: Send security alerts to your favourite messaging platform
    </a>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
      </span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#1-available-resources" class="md-nav__link">
    1. Available resources:
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#2-validate-environment-setup" class="md-nav__link">
    2. Validate environment setup
  </a>
  
    <nav class="md-nav" aria-label="2. Validate environment setup">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#1-check-iot-devices-powered-by-lambda-functions" class="md-nav__link">
    1. Check IoT Devices powered by Lambda functions
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2-check-iot-device-powered-by-cloud9-environment" class="md-nav__link">
    2. Check IoT Device powered by Cloud9 environment
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#3-aws-iot-things" class="md-nav__link">
    3. AWS IoT Things
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#3-check-if-your-devices-are-sending-data-to-aws-iot" class="md-nav__link">
    3. Check if your devices are sending data to AWS IoT
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                  <a href="https://github.com/aws-samples/protect-your-iot-fleet/edit/master/docs/Module 1: Environment build/README.md" title="Edit this page" class="md-content__button md-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20.71 7.04c.39-.39.39-1.04 0-1.41l-2.34-2.34c-.37-.39-1.02-.39-1.41 0l-1.84 1.83 3.75 3.75M3 17.25V21h3.75L17.81 9.93l-3.75-3.75L3 17.25z"/></svg>
                  </a>
                
                
                  
                
                
                <h1 id="module-1-environment-build">Module 1: Environment build</h1>
<p>This module walks your through IoT environment setup for this workshop. You will need an AWS account. Depending on the scenerios below, expand one of the following dropdowns to start.</p>
<p><strong><details><summary>Click here if you are at an AWS event where the Event Engine is being used</summary><br></strong>
If you are at an AWS Sponsored event, you will be provided with either an AWS account or a hash key for Event Engine. Environment setup has been completed for you. You don't need to perform any provisioning in this module. To get start, go to <a href="#available-resources">Available resources</a> to check what are already provisioned.
</details></p>
<p><strong><details><summary>Click here if you are using your own AWS account (whether you are at an AWS event, a separate event or online)</summary><br></strong>
You will need to set up environment for this lab following these steps:</p>
<ol>
<li><strong>Choose a region:</strong> sign in to your AWS Account. From AWS console home, choose a region that works best for you from the top right corner of the console. For example, Ohio or Oregon if you're in North America. </li>
<li><strong>Create a S3 bucket:</strong> You will use CloudFormation to provision neccesary resources, including multiple Lambda functions. You need to use a S3 bucket to store deployment packages of these Lambda functions. If you don't have a S3 bucket, create a new one. Or you can use an existing non-prod bucket.</li>
<li>Download CloudFormation template <a href="setupinfra.yml">setupinfra.yml</a> and save it locally on your laptop/computer. Next you will create deployment package for 3 Lambda functions</li>
<li>
<p>Create deployment package for Lambda function 'Device': This deployment package is for Lambda functions act as IoT Devices. To create deployment package, follow these steps</p>
<p>4.1. Clone this workshop github repo, change directory to 'Module 1: Environment build', navigate to folder 'device'. This folder should only have a python script device.py at the moment.</p>
<p>4.2. We will install neccessary dependecies for this python script. Under device folder, create a subfolder called Package. 
  <code>bash
  mkdir Package
  cd Package</code></p>
<p>4.3. Install these dependencies, choose Package as target folder
  <code>bash
  pip install --target . AWSIoTPythonSDK boto3 requests</code></p>
<p>4.4. Create a zip archive of the dependencies in Package and store it in device folder. Run this command when you currently in Package folder
  <code>bash
  zip -r9 ../device.zip .</code></p>
<p>4.5. Add python script device.py to the archive
  <code>bash
  cd ..
  zip -g device.zip device.py</code></p>
<p>4.6. Upload this zip file to your S3 bucket. <strong>Note:</strong> This deployment package need to be at the top level, and not in any folder of the S3 bucket</p>
</li>
<li>
<p>Create deployment package for Lambda function 'registerdevice': This deployment package is for a Lambda function that creates X.509 certificate, its private key and store it in AWS Secrets Manager. This function also creates an IoT Core policy and attachs it to X.509 certificate. To create deployment package, follow these steps</p>
<p>5.1. From directory 'Module 1: Environment build', navigate to folder 'registerDevice'. This folder should only have a javascript registerdevice.js at the moment.</p>
<p>5.2 Create a zip file from this javascript: </p>
<p><code>bash
  zip registerdevice.zip registerdevice.js</code></p>
<p>5.3. Upload this zip file to your S3 bucket. <strong>Note:</strong> This deployment package need to be at the top level, and not in any folder of the S3 bucket</p>
</li>
<li>
<p>Create deployment package for Lamdba function 'startaudit': this deployment package is for a Lambda function that start an on-demand Device Defender Audit</p>
<p>6.1. From directory 'Module 1: Environment build', navigate to folder 'startaudit'. This folder should only have a javascript startaudit.js at the moment.</p>
<p>6.2 Create a zip file from this javascript: </p>
<p><code>bash
  zip startaudit.zip startaudit.js</code></p>
<p>6.3. Upload this zip file to your S3 bucket. <strong>Note:</strong> This deployment package need to be at the top level, and not in any folder of the S3 bucket</p>
</li>
<li>
<p>Create a new CloudFormation stack to provision AWS resources:</p>
<p>7.1. From CloudFormation console, click <strong>Create stacks, With new resources (standard)</strong></p>
<p>7.2. Choose <strong>Upload a new template</strong>, and upload the CloudFormation template that you download to your laptop/computer earlier in step 3. Click <strong>Next</strong></p>
<p>7.3. Name this new CloudFormation stack. Under Parameter session, provide the <strong>name of the S3 bucket</strong> that you create in step 2. We recommend you to keep the default values of <strong>IoT Parameters</strong> for easy reference when you go through this workshop. You can provide values for these parameters if you are comfortable working with AWS IoT Thing and Topics.  </p>
<div class="codehilite"><pre><span></span><code><span class="err">&lt;img src=&quot;../images/s3parameter.png&quot;/&gt;</span>
</code></pre></div>


<p>7.4. Leave everything by default in <strong>Configure stack options</strong>. Click <strong>Next</strong> to go to review step</p>
<p>7.5. In <strong>Review</strong>, scroll down to <strong>The following resource(s) require capabilities: [AWS::IAM::ManagedPolicy]</strong>. Check the box next to <strong>I acknowledge that AWS CloudFormation might create IAM resources.</strong>. Click <strong>Create stack</strong>. The stack  will take 5-10 minutes to complete. When the stack completes, move to <a href="#1-available-resources">Available resources</a></p>
</li>
</ol>
</details>

<ol>
<li><a href="#1-available-resources">Available resources</a></li>
<li><a href="#2-validate-environment-setup">Validate environment setup</a></li>
<li><a href="#3-check-if-your-devices-are-sending-data-to-aws-iot">Check if your devices are sending data to AWS IoT</a></li>
</ol>
<h2 id="1-available-resources">1. Available resources:</h2>
<p>If you are at an AWS Event, you should be provided an AWS Account with the resources below ready to use. Otherwise, you will need to use your AWS Account and provision resources by following <a href="/Module%201:%20Environment%20build/README.md">"Click here if you are using your own AWS account (whether you are at an AWS event, a separate event or online)"</a> at the beginning of this module</p>
<p>Here is the list of resources:</p>
<ul>
<li>3 IoT Devices:  Device <strong>SensorDevice01</strong> and <strong>SensorDevice02</strong> are powered by Lambda functions. Device <strong>SensorDevice03</strong> is a Cloud9 environment (so that you can access this device and install Device Defender agent later in this workshop)</li>
<li>3 AWS IoT Things named <strong>Thing01</strong>, <strong>Thing02</strong>, <strong>Thing03</strong></li>
<li>3 AWS IoT Topic <strong>temperature-device-01</strong>, <strong>temperature-device-02</strong>, <strong>temperature-device-03</strong></li>
<li>1 X.509 Certificate and it's private key stored in AWS Secrets Manager</li>
<li>1 AWS IoT Core Policy named as <strong>DevicePolicy-[CloudFormationStackname]</strong></li>
<li>1 on-demand Audit</li>
<li>1 SNS topic named as <strong>BadIoTDevices-[CloudFormation stackname]</strong>.  You will use this SNS topic to receive security realated alerts from AWS IoT Device Defender. </li>
</ul>
<p><strong>IMPORTANT: You need to subscribe your email to this SNS topic to receive notifications. If this is the first time you subscribe to a SNS topic, follow this <a href="https://docs.aws.amazon.com/sns/latest/dg/sns-tutorial-create-subscribe-endpoint-to-topic.html#create-subscribe-endpoint-to-topic-aws-console">tutorial</a>. After subscribe your email address, remember to CONFIRM YOUR SUBSCRIPTION</strong></p>
<p>Here is the architecture diagram for the environment setup:</p>
<p><img src="../images/IoTSecurityWorkshopInfra.png"/></p>
<p>Let's move to the next step, where you can validate if the environment setup is correct</p>
<h2 id="2-validate-environment-setup">2. Validate environment setup</h2>
<h3 id="1-check-iot-devices-powered-by-lambda-functions">1. Check IoT Devices powered by Lambda functions</h3>
<p>In this workshop, we will use 2 Lambda functions acting as 2 seperate IoT Devices: SensorDevice01 and SensorDevice02.  Each device will send temperature telemetry to AWS IoT every 10 seconds. </p>
<p>To understand how the devices send data, let's look at the code of Lambda functions (writen in Python):</p>
<ol>
<li>From the AWS console home, click <strong>Lambda</strong></li>
<li>
<p>Once you're in Lambda management console, click <strong>Functions</strong> on the left side. Then click on <strong>SensorDevice01</strong> (you can search for 'SensorDevice' name if you have too many funtions.</p>
</li>
<li>
<p>Scroll down to <strong>Function code</strong> and you will see  the Python code of this Lambda function. Here is a quick walk through what it does:</p>
<p>a. First, the function will retrieve <a href="https://docs.aws.amazon.com/iot/latest/developerguide/iot-custom-endpoints.html">AWS IoT Endpoint</a> to send telemetry data to. </p>
<div class="codehilite"><pre><span></span><code><span class="err">          endpoint = iot.describe_endpoint(endpointType=&#39;iot:Data-ATS&#39;)</span>
<span class="err">          endpointaddress = endpoint[&#39;endpointAddress&#39;]</span>
</code></pre></div>


<p>b. Next, it checks if there is  a X.509 device certificate, private key, and <a href="https://docs.aws.amazon.com/iot/latest/developerguide/server-authentication.html#server-authentication-certs">root CA certificate</a>(for server authentication) available in /tmp (<a href="https://docs.aws.amazon.com/lambda/latest/dg/best-practices.html#function-code">local storage directory for Lambda function</a>). If not, it will retrieve these files from AWS Secrets Manager. IoT device needs these files to connect to AWS IoT.</p>
<div class="codehilite"><pre><span></span><code><span class="err">    if os.path.isfile(&#39;/tmp/cert.pem&#39;):</span>
<span class="err">       print(&#39;/tmp/cert.pem is available&#39;)</span>
<span class="err">    else:</span>
<span class="err">       certpem = secretmanager.get_secret_value(SecretId=&#39;CertPem&#39;+stackname)</span>
<span class="err">       newcert = open(&#39;/tmp/cert.pem&#39;, &#39;w+&#39;)</span>
<span class="err">       newcert.write(certpem[&#39;SecretString&#39;])</span>
<span class="err">       newcert.close()</span>
<span class="err">          ....more code </span>
<span class="err">    //download Amazon RootCA1 certificate</span>
<span class="err">    if os.path.isfile(&#39;/tmp/rootca.pem&#39;):</span>
<span class="err">       print(&#39;/tmp/rootca.pem is available&#39;)</span>
<span class="err">    else:</span>
<span class="err">       url = &#39;https://www.amazontrust.com/repository/AmazonRootCA1.pem&#39;</span>
<span class="err">       newrootcapem = requests.get(url)</span>
<span class="err">       open(&#39;/tmp/rootca.pem&#39;, &#39;wb&#39;).write(newrootcapem.content)</span>
</code></pre></div>


<p>c. Next, it connects with AWS IoT using AWS IoT Python SDK </p>
<div class="codehilite"><pre><span></span><code><span class="err">    myMQTTClient = AWSIoTMQTTClient(devicename)</span>
<span class="err">    myMQTTClient.configureEndpoint(endpointaddress, 8883)</span>
<span class="err">    myMQTTClient.configureCredentials(&quot;/tmp/rootca.pem&quot;, &quot;/tmp/private.key&quot;, &quot;/tmp/cert.pem&quot;)</span>
</code></pre></div>


<p>d. Finally, It generates random temperature telemetry data and sends it to AWS IoT Endpoint</p>
<div class="codehilite"><pre><span></span><code><span class="err">    telemetrydata = round(random.uniform(15.1,29.9),2)</span>
<span class="err">    #Connect to AWS IoT</span>
<span class="err">    myMQTTClient.connect()</span>
<span class="err">    myMQTTClient.publish(topicname, telemetrydata, 0)</span>
<span class="err">    myMQTTClient.disconnect()</span>
</code></pre></div>


</li>
</ol>
<h3 id="2-check-iot-device-powered-by-cloud9-environment">2. Check IoT Device powered by Cloud9 environment</h3>
<p>The third IoT device <strong>SensorDevice03</strong> will be powered by a Cloud9 environment (so that you can log into this device later to instance Device Defender agent). To check if this Cloud9 environment is accessible, following these steps:</p>
<ol>
<li>From AWS Console home, click or search for <strong>Cloud9</strong></li>
<li>Click on <strong>Your environments</strong> on the left side to view the list of environments.  Select <strong>SensorDevice03</strong>, and click <strong>Open IDE</strong>. Wait for a few minutes for the environment to be accesible. </li>
<li>You need to check if this Cloud9 environment has source code of AWS Device Defender Agent - so that you can install this agent later in this workshop. From the terminal, run these linux command:<div class="codehilite"><pre><span></span><code><span class="err">cd ~/environment/workshop</span>
<span class="err">ls -l</span>
</code></pre></div>


<p>You should see the source code <strong>AWSIoTDeviceDefenderAgentSDK</strong> 
 <img src="../images/cloud9check.png"/></p>
</li>
</ol>
<h3 id="3-aws-iot-things">3. AWS IoT Things</h3>
<p>Three AWS IoT Things <strong>Thing01, Thing02, Thing03</strong> are already created for you. These Things are associated with a X.509 certificate (you'll learn more why using one certificate for multiple devices isn't a best practices in <a href="/Module%202:%20Audit%20your%20IoT%20Fleet">Module 2: Audit your IoT Fleet</a>. When devices <strong>SensorDevice01,SensorDevice02, SensorDevice03</strong> connect to AWS IoT, it needs to present this X.509 certificate and it's private key to prove that it is the Things registered with AWS IoT. You'll need to validate <strong>Thing01, Thing02, Thing03</strong> configuration to understand how AWS IoT associate these Thing with devices.</p>
<ul>
<li>From AWS console home, click <strong>IoT Core</strong> to go to IoT management console.</li>
<li>Click <strong>Manage, Things</strong> to view the list of IoT Things</li>
<li>To get more information about a Thing, click on the Thing name (for example, <strong>Thing01</strong>). </li>
<li>Each Thing need to use a X.509 certificate to authenticate with AWS IoT. To validate which certificate is associated to this <strong>Thing01</strong>, go to <strong>Security</strong>. You should see a X.509 already associates with this Thing.</li>
</ul>
<p><img src="../images/ThingSecurity.png"/></p>
<ul>
<li>This X.509 certificate need to be valid and activated. To check, click the certificate to get more information. You should see this certificate is issued by Amazon Web Services. It is currently <strong>Active</strong> with an Expiration date</li>
</ul>
<p><img src="../images/thingcert.png"/></p>
<ul>
<li>
<p>Remember that X.509 certificate is for Authentication. Now you need to validate device's Authorization - what actions this device is allowed to perform. AWS IoT use IoT Core Policy and IAM Policy. In this workshop, we will use IoT Core Policy to grant permission to devices. To understand how AWS use IAM Policy, take a look at <a href="https://docs.aws.amazon.com/iot/latest/developerguide/iam-policies.html">this IAM policies document</a></p>
</li>
<li>
<p>AWS IoT Core policies determine which operations are allowed. Operations are divided into two groups: data plane and control plane. </p>
<ul>
<li>Control plane API allows you to perform administrative tasks like creating or updating certificates, things, rules, and so on.</li>
<li>Data plane API allows you send data to and receive data from AWS IoT Core.
   If you would like to dive deeper into AWS IoT Core policies, follow <a href="https://docs.aws.amazon.com/iot/latest/developerguide/iot-policies.html">this AWS IoT Core Policies document</a> </li>
</ul>
</li>
<li>
<p>To check which actions that your AWS IoT Thing can perform, you need to check the IoT Core Policies (or Policies in short) that associate with this Thing. Each Thing can have multiple Policies. A Policy can be attached to a X.509 certificate, or an AWS IoT Thing Group. In <a href="/Module%203:%20Detect%20and%20response%20to%20a%20compromised%20device">Module 3: Detect and response to a compromised device</a>, you will create a Policy and attach it to a Thing Group. As for now you will check an existing Policy associates with X.509 certificate.</p>
</li>
<li>
<p>Go back to Certificate Details (following step 3,4, and 5 above). Click <strong>Policies</strong> to see a Policy named DevicePolicy-[your-stack-name] attached to this X-509 certificate. The naming convention DevicePolicy-[your-stack-name] is to make sure each Policy created automatically by CloudFormation will have a unique name. Click on this Policy and you will see the policy document specifies priviledges of the request that your IoT Devices send to AWS IoT.</p>
</li>
</ul>
<p><img src="../images/DevicePolicy.png" width="600" height="439"/></p>
<p>What do you think about this Policy? What would you do differently to only give appropriate permisison for the Thing associated with this certificate? To get some idea, you can look at <a href="https://docs.aws.amazon.com/iot/latest/developerguide/example-iot-policies.html">example AWS IoT policies here</a></p>
<h3 id="3-check-if-your-devices-are-sending-data-to-aws-iot">3. Check if your devices are sending data to AWS IoT</h3>
<p>To check if you devices are connected to AWS IoT endpoint, go to <strong>Manage, Things</strong></p>
<ol>
<li>Click on any Thing, for examble <strong>Thing01</strong>.</li>
<li>Click on <strong>Activity</strong>. Under <strong>Activity</strong>, you will see the history of Thing connectivity. Click on any entry, you can find more details about the thing name, and the cert that it uses to connect to AWS IoT endpoint.</li>
</ol>
<p><img src="../images/thingactivity.png"/></p>
<p>You can view the messages that devices publish to AWS IoT topics. To view these messages,  go to AWS IoT MQTT client by following these steps</p>
<ol>
<li>
<p>From AWS IoT console, click on <strong>Test, Subscribe to a topic</strong></p>
</li>
<li>
<p>Type in the topic name <strong>temperature-device-01</strong> that your IoT Devices send telemetry data to. In this workshop, the topic names will be "temperature-device-01", "temperature-device-02", "temperature-device-03". If you're running this workshop on your AWS account, and provide unique names for these topics when you use CloudFormation template to create resources, you will need to type in those unique topic names instead of temperature-device-01</p>
</li>
<li>
<p>Click "Subscribe to topic". </p>
</li>
</ol>
<p><img src="../images/mqttclient.png"/></p>
<p>Seeing the temperature records? Yay! Your devices are connected and sending data to AWS IoT. Now your next task is to audit all Things and devices to make sure there is no bad configuration. You can do so by moving to <a href="../Module%202:%20Audit%20your%20IoT%20Fleet">Module 2: Audit your IoT Fleet</a></p>
                
              
              
                


              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid" aria-label="Footer">
        
          <a href=".." title="Overview" class="md-footer-nav__link md-footer-nav__link--prev" rel="prev">
            <div class="md-footer-nav__button md-icon">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
            </div>
            <div class="md-footer-nav__title">
              <div class="md-ellipsis">
                <span class="md-footer-nav__direction">
                  Previous
                </span>
                Overview
              </div>
            </div>
          </a>
        
        
          <a href="../Module%202%3A%20Audit%20your%20IoT%20Fleet/" title="Module 2: Audit your IoT Fleet" class="md-footer-nav__link md-footer-nav__link--next" rel="next">
            <div class="md-footer-nav__title">
              <div class="md-ellipsis">
                <span class="md-footer-nav__direction">
                  Next
                </span>
                Module 2: Audit your IoT Fleet
              </div>
            </div>
            <div class="md-footer-nav__button md-icon">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4z"/></svg>
            </div>
          </a>
        
      </nav>
    </div>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
          <div class="md-footer-copyright__highlight">
            &copy; 2020, Amazon Web Services, Inc. or its affiliates. All rights reserved.
          </div>
        
        Made with
        <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
          Material for MkDocs
        </a>
      </div>
      
  <div class="md-footer-social">
    
      
      
        
        
      
      <a href="https://awssecworkshops.com" target="_blank" rel="noopener" title="awssecworkshops.com" class="md-footer-social__link">
        
      </a>
    
      
      
        
        
      
      <a href="https://aws.amazon.com/security/" target="_blank" rel="noopener" title="aws.amazon.com" class="md-footer-social__link">
        
      </a>
    
      
      
        
        
      
      <a href="https://twitter.com/awssecurityinfo?lang=en" target="_blank" rel="noopener" title="twitter.com" class="md-footer-social__link">
        
      </a>
    
      
      
        
        
      
      <a href="https://aws.amazon.com/blogs/security/" target="_blank" rel="noopener" title="aws.amazon.com" class="md-footer-social__link">
        
      </a>
    
  </div>

    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../assets/javascripts/vendor.c3dc8c49.min.js"></script>
      <script src="../assets/javascripts/bundle.f9edbbd5.min.js"></script><script id="__lang" type="application/json">{"clipboard.copy": "Copy to clipboard", "clipboard.copied": "Copied to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.result.placeholder": "Type to start searching", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents"}</script>
      
      <script>
        app = initialize({
          base: "..",
          features: [],
          search: Object.assign({
            worker: "../assets/javascripts/worker/search.8e2cddea.min.js"
          }, typeof search !== "undefined" && search)
        })
      </script>
      
    
  </body>
</html>